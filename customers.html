<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management - Property MS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* File input */
        .file-input-label { /* ... existing ... */ display: inline-block; padding: 10px 16px; font-size: 14px; background-color: #3b82f6; color: white; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        .file-input-label:hover { background-color: #2563eb; }
        .file-input { display: none; }
        /* Modal item list */
        .item-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #334155; }
        .item-list-item:last-child { border-bottom: none; }
        /* Table row hover */
        #customerTableBody tr { cursor: pointer; }
        #customerTableBody tr:hover td:not(:last-child){ background-color: #334155; }
        /* Detail modal list */
         .detail-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #334155; }
         .detail-item:last-child { border-bottom: none; }
         /* Highlight Due Day */
         .due-day-highlight {
             font-weight: 600; /* semibold */
             color: #facc15; /* yellow-400 */
         }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans">

    <div id="app-container" class="flex h-screen hidden">
        <aside class="w-64 bg-slate-800 p-6 flex-shrink-0 flex flex-col justify-between">
             <div>
                <div class="flex items-center gap-3 mb-10">
                    <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="building-2" class="text-white"></i></div>
                    <h1 class="text-xl font-bold text-white">Property MS</h1>
                </div>
              <nav class="flex flex-col gap-2">
                   <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
                   <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="users"></i><span>Staff Members</span></a>
                    <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Staff Schedule</span></a>
                   <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="contact"></i><span>Customers</span></a>
                   <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="home"></i><span>Properties</span></a>
                   <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="siren"></i><span>Income/Expenses</span></a>
                   <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="boxes"></i><span>Materials Stock</span></a>
                   <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="car"></i><span>Vehicles</span></a>
                   <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Schedule</span></a>
                   <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-check-2"></i><span>Agreements</span></a>
                   <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="key-round"></i><span>App Access</span></a>
                   <a href="./agreement_generator.html" class="nav-link bg-slate-700 text-white flex items-center gap-3 px-4 py-2 rounded-lg transition"><i data-lucide="file-text"></i><span>Proposal Gen</span></a>

                </nav>
            </div>
            <div>
                 <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2 mb-4 rounded-lg transition bg-slate-700 hover:bg-red-600 text-white"><i data-lucide="log-out"></i><span>Sign Out</span></button>
                <div class="text-xs text-slate-500">
                    <p>&copy; 2025 Property MS. All rights reserved.</p>
                    <p class="mt-1">User ID: <span id="userId" class="font-mono">Loading...</span></p>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <section id="page-customers" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Customers</h2>
                    <button id="addCustomerBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center gap-2"><i data-lucide="plus"></i> Add New Customer</button>
                </div>

                <div class="mb-6 border-b border-slate-700">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tabAllCustomers" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-400 border-blue-400">
                            All Customers
                        </button>
                        <button id="tabAlerts" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-300">
                            Due Date Alerts
                        </button>
                    </nav>
                </div>

                <div id="allCustomersContent">
                    <div class="bg-slate-800 rounded-lg p-4 mb-6 flex items-end gap-4">
                        <div class="flex-1">
                            <label for="searchByName" class="block mb-2 text-sm font-medium">Search by Name</label>
                            <input type="text" id="searchByName" placeholder="Enter customer name..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                        </div>
                        <div class="flex-1">
                            <label for="filterCategory" class="block mb-2 text-sm font-medium">Filter by Category</label>
                            <select id="filterCategory" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                                <option value="">All Categories</option>
                                <option value="Condominium">Condominium</option>
                                <option value="Hotel B&B">Hotel B&B</option>
                                <option value="Gardners">Gardners</option>
                                <option value="Staff">Staff</option>
                                <option value="Agency">Agency</option>
                                <option value="Gym">Gym</option>
                                <option value="Laundry">Laundry</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                        <div><button id="clearFiltersBtn" class="bg-slate-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-slate-500 transition">Clear</button></div>
                    </div>

                    <div class="bg-slate-800 rounded-lg overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th class="p-4 font-semibold text-white">Name</th>
                                    <th class="p-4 font-semibold text-white">Category</th>
                                    <th class="p-4 font-semibold text-white">Contact</th>
                                    <th class="p-4 font-semibold text-white">Agreement %</th>
                                    <th class="p-4 font-semibold text-white">Items / Total Price (Rs)</th>
                                    <th class="p-4 font-semibold text-white">Date Added</th>
                                    <th class="p-4 font-semibold text-white">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody">
                                <tr><td colspan="7" class="text-center p-8 text-slate-400">Loading customer data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="alertsContent" class="hidden">
                    <h3 class="text-xl font-bold text-white mb-4">Upcoming Due Payments (Next 7 Days)</h3>
                    <div id="alertsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p id="noAlertsMsg" class="text-slate-400 col-span-full">No upcoming payments found in the next 7 days.</p>
                    </div>
                </div>

            </section>
        </main>
    </div>

    <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-3xl transform transition-all scale-95 opacity-0" id="customer-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="customerModalTitle" class="text-2xl font-bold text-white">Add New Customer</h3>
                <button id="closeCustomerModalBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <form id="customerForm">
                <input type="hidden" id="customerDocId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="customerName" class="block mb-2 text-sm font-medium">Full Name</label>
                        <input type="text" id="customerName" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5" required>
                    </div>
                    <div>
                        <label for="customerCategory" class="block mb-2 text-sm font-medium">Category</label>
                        <select id="customerCategory" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5" required>
                            <option value="" disabled selected>Select a category</option>
                            <option value="Condominium">Condominium</option>
                            <option value="Hotel B&B">Hotel B&B</option>
                            <option value="Gardners">Gardners</option>
                            <option value="Staff">Staff</option>
                            <option value="Agency">Agency</option>
                            <option value="Gym">Gym</option>
                            <option value="Laundry">Laundry</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div>
                        <label for="customerContact" class="block mb-2 text-sm font-medium">Contact Number</label>
                        <input type="text" id="customerContact" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5" required>
                    </div>
                    <div>
                        <label for="customerEmail" class="block mb-2 text-sm font-medium">Email</label>
                        <input type="email" id="customerEmail" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                    </div>
                     <div>
                        <label for="agreementPercentage" class="block mb-2 text-sm font-medium">Agreement Percentage (%)</label>
                        <input type="number" step="0.01" min="0" id="agreementPercentage" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5" placeholder="e.g., 10">
                    </div>
                    <div>
                        <label for="customerDate" class="block mb-2 text-sm font-medium">Date Added</label>
                        <input type="date" id="customerDate" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                    </div>
                </div>

                <div id="categorySpecificDetails" class="hidden border-t border-slate-700 pt-6 mt-6">
                     <h4 id="itemManagementTitle" class="text-lg font-semibold text-white mb-4">Manage Items/Services</h4>
                     <div class="bg-slate-700 p-4 rounded-lg mb-4 flex items-end gap-3">
                        <div class="flex-1">
                            <label for="newItemName" class="block mb-2 text-xs font-medium">Item/Service Name</label>
                            <input type="text" id="newItemName" class="w-full bg-slate-600 border border-slate-500 text-white rounded-lg p-2 text-sm" placeholder="e.g., Condo A1, Room 101">
                        </div>
                         <div class="w-28">
                            <label for="newItemPrice" class="block mb-2 text-xs font-medium">Fixed Price (Rs)</label>
                            <input type="number" step="0.01" min="0" id="newItemPrice" class="w-full bg-slate-600 border border-slate-500 text-white rounded-lg p-2 text-sm" placeholder="e.g., 5000">
                        </div>
                        <div class="w-20">
                            <label for="newItemDueDay" class="block mb-2 text-xs font-medium">Due Day</label>
                            <input type="number" min="1" max="31" id="newItemDueDay" class="w-full bg-slate-600 border border-slate-500 text-white rounded-lg p-2 text-sm" placeholder="1-31">
                        </div>
                        <div>
                            <button type="button" id="addItemToListBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition text-sm flex items-center gap-1 h-9"><i data-lucide="plus" class="w-4 h-4"></i> Add</button>
                        </div>
                     </div>
                     <h5 class="text-md font-semibold text-slate-300 mb-2 mt-4">Added Items/Services:</h5>
                     <div id="itemsList" class="space-y-2 max-h-40 overflow-y-auto border border-slate-700 rounded-lg p-3 bg-slate-800">
                        <p id="noItemsMsg" class="text-sm text-slate-400 italic">No items/services added yet.</p>
                        </div>
                      <p class="mt-2 text-sm text-slate-400">Total Fixed Price: <span id="totalItemPrice" class="font-bold text-white">Rs 0.00</span></p>
                </div>

                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancelCustomerModalBtn" class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-700">Cancel</button>
                    <button type="submit" id="submitCustomerBtn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold flex items-center"><span id="submitCustomerBtnText">Save Customer</span><div id="submitCustomerSpinner" class="loader w-5 h-5 ml-2 hidden"></div></button>
                </div>
            </form>
        </div>
    </div>

    <div id="customerDetailModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-xl transform transition-all scale-95 opacity-0" id="customer-detail-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="customerDetailName" class="text-2xl font-bold text-white">Customer Details</h3>
                <button id="closeCustomerDetailModalBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <div class="grid grid-cols-3 gap-x-4 gap-y-2 text-sm">
                    <span class="text-slate-400">Category:</span><span id="detailCategory" class="col-span-2 font-semibold"></span>
                    <span class="text-slate-400">Contact:</span><span id="detailContact" class="col-span-2 font-semibold"></span>
                    <span class="text-slate-400">Email:</span><span id="detailEmail" class="col-span-2 font-semibold"></span>
                    <span class="text-slate-400">Agreement %:</span><span id="detailAgreement" class="col-span-2 font-semibold"></span>
                    <span class="text-slate-400">Date Added:</span><span id="detailDateAdded" class="col-span-2 font-semibold"></span>
                </div>
                <div id="detailItemsSection" class="hidden border-t border-slate-700 pt-4 mt-4">
                    <h4 class="text-lg font-semibold text-white mb-2">Items / Services</h4>
                    <div id="detailItemsList" class="space-y-1 text-sm bg-slate-700 p-3 rounded-md">
                         <div class="detail-item font-semibold text-slate-300">
                             <span>Name</span>
                             <span>Due Day / Price (Rs)</span>
                        </div>
                    </div>
                     <p class="mt-2 text-sm text-slate-400">Total Fixed Price: <span id="detailTotalItemPrice" class="font-bold text-white">Rs 0.00</span></p>
                </div>
            </div>
             <div class="flex justify-end mt-6"><button type="button" id="closeCustomerDetailModalBtnBottom" class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-700">Close</button></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"><p>Toast message!</p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

         const firebaseConfig = {
             apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
            authDomain: "rsgweb-5f36d.firebaseapp.com",
            projectId: "rsgweb-5f36d",
            storageBucket: "rsgweb-5f36d.firebasestorage.app",
            messagingSenderId: "633023905515",
            appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;
        
        // --- GLOBAL VARIABLES ---
        let allCustomers = [];
        let allTransactions = []; // Transaction data check karanna
        let activeTab = 'allCustomers'; // Default tab
        // --- ---
        
        let tempItems = [];

        // --- DOM Elements (Okkoma kalin wage) ---
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');
        const customerTableBody = document.getElementById('customerTableBody');
        const searchByNameInput = document.getElementById('searchByName');
        const filterCategorySelect = document.getElementById('filterCategory');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const customerModal = document.getElementById('customerModal');
        const customerModalContent = document.getElementById('customer-modal-content');
        const customerModalTitle = document.getElementById('customerModalTitle');
        const addCustomerBtn = document.getElementById('addCustomerBtn');
        const closeCustomerModalBtn = document.getElementById('closeCustomerModalBtn');
        const cancelCustomerModalBtn = document.getElementById('cancelCustomerModalBtn');
        const customerForm = document.getElementById('customerForm');
        const submitCustomerBtn = document.getElementById('submitCustomerBtn');
        const submitCustomerBtnText = document.getElementById('submitCustomerBtnText');
        const submitCustomerSpinner = document.getElementById('submitCustomerSpinner');
        const customerCategorySelect = document.getElementById('customerCategory');
        const categorySpecificDetailsDiv = document.getElementById('categorySpecificDetails');
        const itemManagementTitle = document.getElementById('itemManagementTitle');
        const itemsListDiv = document.getElementById('itemsList');
        const newItemNameInput = document.getElementById('newItemName');
        const newItemPriceInput = document.getElementById('newItemPrice');
        const newItemDueDayInput = document.getElementById('newItemDueDay');
        const addItemToListBtn = document.getElementById('addItemToListBtn');
        const noItemsMsg = document.getElementById('noItemsMsg');
        const totalItemPriceSpan = document.getElementById('totalItemPrice');
        const customerDetailModal = document.getElementById('customerDetailModal');
        const customerDetailModalContent = document.getElementById('customer-detail-modal-content');
        const customerDetailName = document.getElementById('customerDetailName');
        const closeCustomerDetailModalBtn = document.getElementById('closeCustomerDetailModalBtn');
        const closeCustomerDetailModalBtnBottom = document.getElementById('closeCustomerDetailModalBtnBottom');
        const detailCategory = document.getElementById('detailCategory');
        const detailContact = document.getElementById('detailContact');
        const detailEmail = document.getElementById('detailEmail');
        const detailAgreement = document.getElementById('detailAgreement');
        const detailDateAdded = document.getElementById('detailDateAdded');
        const detailItemsSection = document.getElementById('detailItemsSection');
        const detailItemsList = document.getElementById('detailItemsList');
        const detailTotalItemPrice = document.getElementById('detailTotalItemPrice');
        const tabAllCustomers = document.getElementById('tabAllCustomers');
        const tabAlerts = document.getElementById('tabAlerts');
        const allCustomersContent = document.getElementById('allCustomersContent');
        const alertsContent = document.getElementById('alertsContent');
        const alertsList = document.getElementById('alertsList');
        const noAlertsMsg = document.getElementById('noAlertsMsg');
        

        // --- Authentication (Kalin wage) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');
                listenForCustomerUpdates();
                listenForTransactionUpdates(); 
            } else {
                window.location.href = './index.html';
            }
        });

        signOutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Sign out failed:", error));
        });
        
        // --- TAB SWITCHING LOGIC (Kalin wage) ---
        function switchTab(tabId) {
             activeTab = tabId;
             const tabs = [tabAllCustomers, tabAlerts];
             const contents = [allCustomersContent, alertsContent];

             tabs.forEach(tab => {
                 tab.classList.remove('text-blue-400', 'border-blue-400');
                 tab.classList.add('text-slate-400', 'border-transparent', 'hover:text-slate-300', 'hover:border-slate-300');
             });
             contents.forEach(content => content.classList.add('hidden'));

             if (tabId === 'allCustomers') {
                 tabAllCustomers.classList.add('text-blue-400', 'border-blue-400');
                 tabAllCustomers.classList.remove('text-slate-400', 'border-transparent');
                 allCustomersContent.classList.remove('hidden');
                 applyFilters();
             } else if (tabId === 'alerts') {
                 tabAlerts.classList.add('text-blue-400', 'border-blue-400');
                 tabAlerts.classList.remove('text-slate-400', 'border-transparent');
                 alertsContent.classList.remove('hidden');
                 renderAlerts();
             }
        }
        tabAllCustomers.addEventListener('click', () => switchTab('allCustomers'));
        tabAlerts.addEventListener('click', () => switchTab('alerts'));
        
        // --- Modal Logic Okkoma (Kalin wage) ---
        const openCustomerModal = () => {
            customerModal.classList.remove('hidden');
            setTimeout(() => customerModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            document.getElementById('customerDate').valueAsDate = new Date();
        };
        const closeCustomerModal = () => {
            customerModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                customerModal.classList.add('hidden');
                customerForm.reset();
                document.getElementById('customerDocId').value = '';
                customerModalTitle.textContent = 'Add New Customer';
                submitCustomerBtnText.textContent = 'Save Customer';
                categorySpecificDetailsDiv.classList.add('hidden');
                itemsListDiv.innerHTML = '';
                noItemsMsg.style.display = 'block';
                tempItems = [];
                updateModalItemTotal();
            }, 200);
        };
        addCustomerBtn.addEventListener('click', openCustomerModal);
        closeCustomerModalBtn.addEventListener('click', closeCustomerModal);
        cancelCustomerModalBtn.addEventListener('click', closeCustomerModal);
        customerModal.addEventListener('click', (e) => { if(e.target === customerModal) closeCustomerModal(); });
        const openCustomerDetailModal = async (docId) => {
             if (!docId) return;
             try {
                const docRef = doc(db, `users/${currentUserId}/customers`, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const customer = docSnap.data();
                    customerDetailName.textContent = customer.name || 'Customer Details';
                    detailCategory.textContent = customer.category || 'N/A';
                    detailContact.textContent = customer.contact || 'N/A';
                    detailEmail.textContent = customer.email || 'N/A';
                    detailAgreement.textContent = `${customer.agreementPercentage || 0}%`;
                    detailDateAdded.textContent = customer.createdAt?.toDate ? customer.createdAt.toDate().toLocaleDateString() : 'N/A';
                    detailItemsList.innerHTML = '';
                     const headerDiv = document.createElement('div');
                     headerDiv.className = 'detail-item font-semibold text-slate-300';
                     headerDiv.innerHTML = `
                         <span>Name</span>
                         <span>Due Day / Price (Rs)</span>
                     `;
                     detailItemsList.appendChild(headerDiv);
                    if (customer.items && Array.isArray(customer.items) && customer.items.length > 0) {
                        let total = 0;
                        customer.items.forEach(item => {
                             const div = document.createElement('div');
                             div.className = 'detail-item';
                             const dueDayHtml = item.dueDay ? `<span class="due-day-highlight">Day ${item.dueDay}</span>` : 'N/A';
                             div.innerHTML = `
                                 <span>${item.name || 'Unnamed Item'}</span>
                                 <span class="font-semibold">
                                     ${dueDayHtml} / Rs ${(item.price || 0).toFixed(2)}
                                 </span>
                             `;
                             detailItemsList.appendChild(div);
                             total += (item.price || 0);
                        });
                        detailTotalItemPrice.textContent = `Rs ${total.toFixed(2)}`;
                        detailItemsSection.classList.remove('hidden');
                    } else {
                        const noItemsDiv = document.createElement('div');
                        noItemsDiv.className = 'detail-item text-slate-400 italic';
                        noItemsDiv.textContent = 'No items/services added.';
                        detailItemsList.appendChild(noItemsDiv);
                        detailTotalItemPrice.textContent = `Rs 0.00`;
                        detailItemsSection.classList.remove('hidden');
                    }
                    customerDetailModal.classList.remove('hidden');
                    setTimeout(() => customerDetailModalContent.classList.remove('scale-95', 'opacity-0'), 10);
                } else {
                    showToast("Customer details not found.", false);
                }
             } catch(error) {
                 console.error("Error fetching customer details:", error);
                 showToast("Could not load customer details.", false);
             }
        };
        const closeCustomerDetailModal = () => {
            customerDetailModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                customerDetailModal.classList.add('hidden');
            }, 200);
        };
        closeCustomerDetailModalBtn.addEventListener('click', closeCustomerDetailModal);
        closeCustomerDetailModalBtnBottom.addEventListener('click', closeCustomerDetailModal);
        customerDetailModal.addEventListener('click', (e) => { if(e.target === customerDetailModal) closeCustomerDetailModal(); });
        customerCategorySelect.addEventListener('change', (e) => {
            const selectedCategory = e.target.value;
            const categoriesWithItems = ["Condominium", "Hotel B&B", "Gardners", "Gym", "Laundry"];
            if (categoriesWithItems.includes(selectedCategory)) {
                itemManagementTitle.textContent = `Manage ${selectedCategory}`;
                categorySpecificDetailsDiv.classList.remove('hidden');
            } else {
                categorySpecificDetailsDiv.classList.add('hidden');
                if (tempItems.length > 0) {
                     tempItems = [];
                     renderItemListInModal();
                }
            }
        });
        addItemToListBtn.addEventListener('click', () => {
            const name = newItemNameInput.value.trim();
            const price = parseFloat(newItemPriceInput.value) || 0;
            const dueDay = parseInt(newItemDueDayInput.value) || null; 
            if (!name) {
                showToast("Please enter an item/service name.", false);
                return;
            }
            if (dueDay !== null && (dueDay < 1 || dueDay > 31)) {
                 showToast("Please enter a valid Due Day (1-31).", false);
                 newItemDueDayInput.focus();
                 return;
            }
            if (tempItems.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                 showToast(`"${name}" is already added.`, false);
                 return;
            }
            const newItem = { name, price, dueDay, id: `temp_${crypto.randomUUID()}` };
            tempItems.push(newItem);
            renderItemListInModal();
            newItemNameInput.value = '';
            newItemPriceInput.value = '';
            newItemDueDayInput.value = '';
            newItemNameInput.focus();
        });
        itemsListDiv.addEventListener('click', (e) => {
             const removeBtn = e.target.closest('.remove-item-item');
             if (removeBtn) {
                 const itemIdToRemove = removeBtn.dataset.id;
                 tempItems = tempItems.filter(item => item.id !== itemIdToRemove);
                 renderItemListInModal();
             }
        });
        function renderItemListInModal() {
            itemsListDiv.innerHTML = '';
             if (tempItems.length === 0) {
                 noItemsMsg.style.display = 'block';
             } else {
                 noItemsMsg.style.display = 'none';
                 tempItems.sort((a, b) => a.name.localeCompare(b.name));
                 tempItems.forEach(item => {
                     const div = document.createElement('div');
                     div.className = 'item-list-item text-sm';
                     const dueDayText = item.dueDay ? ` <span class="text-xs text-slate-400">(Due: Day ${item.dueDay})</span>` : '';
                     div.innerHTML = `
                         <span>
                             <span class="font-semibold">${item.name}</span>${dueDayText} - Rs ${item.price.toFixed(2)}
                         </span>
                         <button type="button" data-id="${item.id}" class="remove-item-item text-red-500 hover:text-red-400 p-1">
                             <i data-lucide="x-circle" class="w-4 h-4 pointer-events-none"></i>
                         </button>
                     `;
                     itemsListDiv.appendChild(div);
                 });
                 lucide.createIcons();
             }
             updateModalItemTotal();
        }
        function updateModalItemTotal() {
             const total = tempItems.reduce((sum, item) => sum + item.price, 0);
             totalItemPriceSpan.textContent = `Rs ${total.toFixed(2)}`;
        }
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.className = `fixed bottom-10 right-10 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        // --- Customer Form Submit (Kalin wage) ---
        customerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const docId = document.getElementById('customerDocId').value;
            submitCustomerBtn.disabled = true;
            submitCustomerBtnText.classList.add('hidden');
            submitCustomerSpinner.classList.remove('hidden');
            try {
                const customerData = {
                    name: document.getElementById('customerName').value.trim(),
                    contact: document.getElementById('customerContact').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    category: document.getElementById('customerCategory').value,
                    agreementPercentage: parseFloat(document.getElementById('agreementPercentage').value) || 0,
                    items: [],
                };
                const dateValue = document.getElementById('customerDate').value;
                 if (!customerData.name || !customerData.contact || !customerData.category) {
                     showToast("Please fill in Name, Contact, and Category.", false);
                     throw new Error("Missing required fields");
                 }
                const categoriesWithItems = ["Condominium", "Hotel B&B", "Gardners", "Gym", "Laundry"];
                if (categoriesWithItems.includes(customerData.category)) {
                    customerData.items = tempItems.map(({ name, price, dueDay }) => ({
                        name,
                        price,
                        dueDay: dueDay || null
                    }));
                     customerData.items.sort((a,b) => a.name.localeCompare(b.name));
                }
                if (docId) {
                    if(dateValue) customerData.createdAt = new Date(dateValue);
                     else {
                         const existingDoc = await getDoc(doc(db, `users/${currentUserId}/customers`, docId));
                         if (existingDoc.exists() && existingDoc.data().createdAt) {
                             customerData.createdAt = existingDoc.data().createdAt;
                         }
                     }
                     if (!categoriesWithItems.includes(customerData.category)) {
                        customerData.items = [];
                     }
                    await updateDoc(doc(db, `users/${currentUserId}/customers`, docId), customerData);
                    showToast('Customer updated successfully!');
                } else {
                    customerData.createdAt = dateValue ? new Date(dateValue) : new Date();
                    await addDoc(collection(db, `users/${currentUserId}/customers`), customerData);
                    showToast('Customer added successfully!');
                }
                closeCustomerModal();
            } catch (error) {
                 if (error.message !== "Missing required fields") {
                     console.error("Error saving customer:", error);
                     showToast(`Error: ${error.message}`, false);
                 }
            } finally {
                submitCustomerBtn.disabled = false;
                submitCustomerBtnText.classList.remove('hidden');
                submitCustomerSpinner.classList.add('hidden');
            }
        });


        // --- Render Table Logic (Kalin wage) ---
        async function renderCustomerTable(customerList) {
            customerTableBody.innerHTML = '';
            if (customerList.length === 0) {
                customerTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-slate-400">No customers found matching criteria.</td></tr>`;
                return;
            }
            customerList.forEach((customer) => {
                const row = customerTableBody.insertRow();
                row.dataset.docId = customer.id;
                let detailsHtml = 'N/A';
                let itemCount = 0;
                let totalPrice = 0;
                if (customer.items && Array.isArray(customer.items) && customer.items.length > 0) {
                    itemCount = customer.items.length;
                    totalPrice = customer.items.reduce((sum, item) => sum + (item.price || 0), 0);
                    detailsHtml = `<span class="font-semibold">${itemCount} Item(s)</span><br>Rs ${totalPrice.toFixed(2)}`;
                }
                const addedDate = customer.createdAt?.toDate ? customer.createdAt.toDate().toLocaleDateString() : 'N/A';
                row.innerHTML = `
                    <td class="p-4">${customer.name || 'N/A'}</td>
                    <td class="p-4">${customer.category || 'N/A'}</td>
                    <td class="p-4">${customer.contact || 'N/A'}</td>
                    <td class="p-4">${customer.agreementPercentage || '0'}%</td>
                    <td class="p-4 text-sm">${detailsHtml}</td>
                    <td class="p-4">${addedDate}</td>
                    <td class="p-4 flex items-center gap-2">
                       <button data-id="${customer.id}" class="edit-customer-btn text-blue-400 hover:text-blue-300"><i data-lucide="edit" class="w-5 h-5 pointer-events-none"></i></button>
                       <button data-id="${customer.id}" class="delete-customer-btn text-red-400 hover:text-red-300"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                    </td>
                `;
            });
            lucide.createIcons();
        }

        // --- DATA LISTENER (Transactions) (Kalin wage) ---
        function listenForTransactionUpdates() {
            if(!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/transactions`), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                if (activeTab === 'alerts') {
                    renderAlerts();
                }
            }, error => {
                console.error("Error listening for transaction updates:", error);
                showToast("Error loading payment data.", false);
            });
        }
        
        // --- CUSTOMER LISTENER (Kalin wage) ---
        const listenForCustomerUpdates = () => {
             if(!currentUserId) return;
             onSnapshot(collection(db, `users/${currentUserId}/customers`), (snapshot) => {
                allCustomers = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                 allCustomers.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                if (activeTab === 'allCustomers') {
                    applyFilters();
                } else if (activeTab === 'alerts') {
                    renderAlerts();
                }
             }, error => {
                console.error("Error listening for customer updates:", error);
                customerTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-red-400">Error loading customer data.</td></tr>`;
                showToast("Error loading customer data.", false);
             });
        };

        // --- FILTER LOGIC (Kalin wage) ---
        function applyFilters() {
            const category = filterCategorySelect.value;
            const searchTerm = searchByNameInput.value.toLowerCase();
            let filtered = allCustomers;
            if (searchTerm) {
                filtered = filtered.filter(c => c.name && c.name.toLowerCase().includes(searchTerm));
            }
            if (category) {
                filtered = filtered.filter(c => c.category === category);
            }
            renderCustomerTable(filtered);
        }
        searchByNameInput.addEventListener('input', applyFilters);
        filterCategorySelect.addEventListener('change', applyFilters);
        clearFiltersBtn.addEventListener('click', () => {
            searchByNameInput.value = '';
            filterCategorySelect.value = '';
            applyFilters();
        });

        // --- Edit Modal Logic (Kalin wage) ---
        async function openEditModal(docId) {
            try {
                const docRef = doc(db, `users/${currentUserId}/customers`, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const customer = docSnap.data();
                    customerModalTitle.textContent = 'Edit Customer';
                    submitCustomerBtnText.textContent = 'Update Customer';
                    document.getElementById('customerDocId').value = docId;
                    document.getElementById('customerName').value = customer.name || '';
                    document.getElementById('customerContact').value = customer.contact || '';
                    document.getElementById('customerEmail').value = customer.email || '';
                    document.getElementById('customerCategory').value = customer.category || '';
                    document.getElementById('agreementPercentage').value = customer.agreementPercentage || '';
                    if (customer.createdAt && customer.createdAt.toDate) {
                         document.getElementById('customerDate').value = customer.createdAt.toDate().toISOString().split('T')[0];
                    } else {
                         document.getElementById('customerDate').value = '';
                    }
                    tempItems = [];
                    const categoriesWithItems = ["Condominium", "Hotel B&B", "Gardners", "Gym", "Laundry"];
                    if (categoriesWithItems.includes(customer.category)) {
                        categorySpecificDetailsDiv.classList.remove('hidden');
                        itemManagementTitle.textContent = `Manage ${customer.category}`;
                        if (customer.items && Array.isArray(customer.items)) {
                             tempItems = customer.items.map((item, index) => ({
                                 name: item.name || '',
                                 price: item.price || 0,
                                 dueDay: item.dueDay || null,
                                 id: `temp_${Date.now()}_${index}`
                             }));
                        }
                        renderItemListInModal();
                    } else {
                        categorySpecificDetailsDiv.classList.add('hidden');
                        renderItemListInModal();
                    }
                    openCustomerModal();
                } else {
                    showToast("Customer not found.", false);
                }
            } catch (error) {
                console.error("Error fetching customer for edit:", error);
                showToast(`Error fetching data: ${error.message}`, false);
            }
        }


        // --- Main Table Click Listener (Kalin wage) ---
        customerTableBody.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-customer-btn');
            if (deleteBtn) {
                e.stopPropagation();
                const docId = deleteBtn.dataset.id;
                if(confirm('Are you sure you want to delete this customer and all their associated items/services?')) {
                    try {
                        await deleteDoc(doc(db, `users/${currentUserId}/customers`, docId));
                        showToast('Customer deleted successfully.');
                    } catch (error) {
                         console.error("Error deleting customer:", error);
                         showToast(`Error deleting customer: ${error.message}`, false);
                    }
                }
                return;
            }
            const editBtn = e.target.closest('.edit-customer-btn');
            if (editBtn) {
                 e.stopPropagation();
                openEditModal(editBtn.dataset.id);
                 return;
            }
            const row = e.target.closest('tr');
            if (row && row.dataset.docId) {
                 if (!e.target.closest('td:last-child')) {
                    openCustomerDetailModal(row.dataset.docId);
                 }
            }
        });
        
        // --- *** HADAPU THANA: ALERTS LOGIC (isPaidThisMonth + renderAlerts) *** ---
        
        // Helper function: me mase gewalada kiyala balanawa
        // *** MEKA HADUWA ***
        function isPaidThisMonth(customerName, itemName, year, month) {
            if (!allTransactions || allTransactions.length === 0) return false;

            const searchCustomer = customerName.toLowerCase();
            const searchItem = itemName.toLowerCase();
            // "Mark as Paid" eken save wena unique description eka
            const expectedDescription = `fixed_payment: ${searchCustomer} | ${searchItem}`;

            return allTransactions.some(t => {
                if (t.type !== 'Income' || !t.date || !t.date.toDate) return false;

                const transDate = t.date.toDate();
                // Adala mase witharak check karanawa
                if (transDate.getFullYear() !== year || transDate.getMonth() !== month) return false;

                const description = (t.description || '').toLowerCase();
                
                // Description eka harima eka wenna one
                return description === expectedDescription;
            });
        }
        
        // Alert tab eka render karana function eka
        // *** MEKA HADUWA (DATE LOGIC) ***
        function renderAlerts() {
            alertsList.innerHTML = '';
            let alertsFound = false;

            const now = new Date();
            // 'today' kiyanne ada dawasa 00:00:00
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); 
            
            // 'sevenDaysFromNow' kiyanne ada idan dawas 7k GIHILLA (e.g., 18+7 = 25 wenida 00:00:00)
            // Range eka wenne: [today, sevenDaysFromNow)
            // Oct 18, 19, 20, 21, 22, 23, 24 (Oct 25 NA)
            const sevenDaysFromNow = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 7);

            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            let upcomingPayments = [];

            allCustomers.forEach(customer => {
                if (customer.items && Array.isArray(customer.items)) {
                    customer.items.forEach(item => {
                        if (item.dueDay) {
                            const dueDay = parseInt(item.dueDay);
                            if (isNaN(dueDay) || dueDay < 1 || dueDay > 31) return; 

                            // 1. Me masata adala due date eka
                            const dateThisMonth = new Date(currentYear, currentMonth, dueDay);
                            
                            // 2. Ilaga masata adala due date eka
                            const dateNextMonth = new Date(currentYear, currentMonth + 1, dueDay);

                            let dateToCheck = null;

                            // Me mase due date eka 7-day window eke thiyenawada?
                            // e.g., today=Oct 18, sevenDays=Oct 25, dueDay=19
                            // dateThisMonth = Oct 19
                            // Check: Oct 19 >= Oct 18 (TRUE) && Oct 19 < Oct 25 (TRUE)
                            if (dateThisMonth >= today && dateThisMonth < sevenDaysFromNow) {
                                dateToCheck = dateThisMonth;
                            } 
                            // Ilaga mase due date eka 7-day window eke thiyenawada?
                            // e.g., today=Oct 28, sevenDays=Nov 4, dueDay=2
                            // dateNextMonth = Nov 2
                            // Check: Nov 2 >= Oct 28 (TRUE) && Nov 2 < Nov 4 (TRUE)
                            else if (dateNextMonth >= today && dateNextMonth < sevenDaysFromNow) {
                                dateToCheck = dateNextMonth;
                            }

                            if (dateToCheck) {
                                const checkYear = dateToCheck.getFullYear();
                                const checkMonth = dateToCheck.getMonth();
                                
                                // Adala maseta gewalada balanawa
                                const isPaid = isPaidThisMonth(customer.name, item.name, checkYear, checkMonth);

                                if (!isPaid) {
                                    alertsFound = true;
                                    upcomingPayments.push({
                                        date: dateToCheck,
                                        customerName: customer.name,
                                        customerCategory: customer.category,
                                        itemName: item.name,
                                        amount: item.price
                                    });
                                }
                            }
                        }
                    });
                }
            });

            // Date eka anuwa sort karanawa
            upcomingPayments.sort((a,b) => a.date - b.date);
            
            // Render alerts
            upcomingPayments.forEach(payment => {
                const alertEl = document.createElement('div');
                alertEl.className = 'bg-slate-700 p-4 rounded-lg flex flex-col justify-between gap-3';
                
                alertEl.innerHTML = `
                    <div>
                        <div class="flex items-start gap-3">
                            <div><i data-lucide="bell-ring" class="w-5 h-5 text-green-400 flex-shrink-0 mt-1"></i></div>
                            <div>
                                <p class="font-bold">${payment.itemName}</p>
                                <p class="text-sm text-slate-400">Owner: ${payment.customerName}</p>
                                <p class="text-sm text-slate-400">Category: ${payment.customerCategory}</p>
                                <p class="text-sm text-slate-300 italic">Due Date: ${payment.date.toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="text-right mt-2">
                             <p class="font-semibold text-lg text-green-300">Rs ${payment.amount.toLocaleString() || '0.00'}</p>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-2">
                        <button class="mark-as-paid-btn text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-md flex items-center gap-2"
                                data-customer-name="${payment.customerName}"
                                data-item-name="${payment.itemName}"
                                data-amount="${payment.amount}"
                                data-category="${payment.customerCategory}">
                            <i data-lucide="check" class="w-4 h-4"></i> Mark as Paid
                        </button>
                    </div>
                `;
                alertsList.appendChild(alertEl);
            });

            if (alertsFound) {
                noAlertsMsg.classList.add('hidden');
            } else {
                noAlertsMsg.classList.remove('hidden');
            }
            lucide.createIcons();
        }
        
        // "Mark as Paid" button eka
        // *** MEKA HADUWA ***
        alertsList.addEventListener('click', async (e) => {
             const markPaidBtn = e.target.closest('.mark-as-paid-btn');
             if (markPaidBtn) {
                const { customerName, itemName, amount, category } = markPaidBtn.dataset;
                
                if (!customerName || !itemName) return;
                
                if (confirm(`Record payment of Rs ${amount} for "${itemName}" from "${customerName}"?`)) {
                    markPaidBtn.disabled = true;
                    markPaidBtn.textContent = 'Saving...';
                    
                    try {
                        // *** DESCRIPTION EKA WENAS KALA ***
                        const uniqueDescription = `FIXED_PAYMENT: ${customerName.toLowerCase()} | ${itemName.toLowerCase()}`;

                        const transactionData = {
                            date: new Date(), // Gewwe ada
                            description: uniqueDescription, // Unique description eka
                            category: `Customer Payment (${category})`, 
                            type: 'Income',
                            amount: parseFloat(amount) || 0,
                            paymentMethod: 'Cash' // Default
                        };
                        await addDoc(collection(db, `users/${currentUserId}/transactions`), transactionData);
                        showToast('Payment recorded successfully!');
                        // Listener eka nisa auto refresh wei
                    } catch (error) {
                        showToast(`Error recording payment: ${error.message}`, false);
                        markPaidBtn.disabled = false;
                        markPaidBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Mark as Paid';
                        lucide.createIcons();
                    }
                }
             }
        });
        
        // --- ---

        lucide.createIcons();
    </script>
</body>
</html>