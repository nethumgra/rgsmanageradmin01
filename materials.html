<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materials Stock - Property MS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-input-label {
            display: inline-block;
            padding: 10px 16px;
            font-size: 14px;
            background-color: #3b82f6;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-input-label:hover {
            background-color: #2563eb;
        }
        .file-input {
            display: none;
        }
        /* Clickable row style */
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        /* Make only specific columns clickable, not the whole row if actions are present */
        #bulkTableBody td:not(:last-child) {
            cursor: pointer;
        }
        #bulkTableBody tr:hover td:not(:last-child) {
             background-color: #334155; /* slate-700 */
        }
        #summaryTableBody tr.clickable-row:hover {
             background-color: #334155; /* slate-700 */
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans">

    <div id="app-container" class="flex h-screen hidden">
        <aside class="w-64 bg-slate-800 p-6 flex-shrink-0 flex flex-col justify-between">
            <div>
                <div class="flex items-center gap-3 mb-10">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i data-lucide="building-2" class="text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-white">Property MS</h1>
                </div>
            <nav class="flex flex-col gap-2">
                   <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
                   <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="users"></i><span>Staff Members</span></a>
                    <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Staff Schedule</span></a>
                   <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="contact"></i><span>Customers</span></a>
                   <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="home"></i><span>Properties</span></a>
                   <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="siren"></i><span>Income/Expenses</span></a>
                   <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="boxes"></i><span>Materials Stock</span></a>
                   <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="car"></i><span>Vehicles</span></a>
                   <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Schedule</span></a>
                   <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-check-2"></i><span>Agreements</span></a>
                   <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="key-round"></i><span>App Access</span></a>
                   <a href="./agreement_generator.html" class="nav-link bg-slate-700 text-white flex items-center gap-3 px-4 py-2 rounded-lg transition"><i data-lucide="file-text"></i><span>Proposal Gen</span></a>

                </nav>
            </div>
            <div>
                 <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2 mb-4 rounded-lg transition bg-slate-700 hover:bg-red-600 text-white">
                    <i data-lucide="log-out"></i><span>Sign Out</span>
                </button>
                <div class="text-xs text-slate-500">
                    <p>&copy; 2025 Property MS. All rights reserved.</p>
                    <p class="mt-1">User ID: <span id="userId" class="font-mono">Loading...</span></p>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <section id="page-materials" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Materials Stock</h2>
                    <div class="flex gap-4">
                        <button id="addStockInBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition flex items-center gap-2">
                            <i data-lucide="arrow-down-circle"></i> Add Incoming Stock
                        </button>
                        <button id="addStockOutBtn" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition flex items-center gap-2">
                            <i data-lucide="arrow-up-circle"></i> Issue Stock
                        </button>
                    </div>
                </div>

                <div class="mb-6 border-b border-slate-700">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tabBulk" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-400 border-blue-400">
                            Bulk Purchases
                        </button>
                        <button id="tabSummary" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-300">
                            Item Summary
                        </button>
                        <button id="tabHistory" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-300">
                            All Transactions
                        </button>
                    </nav>
                </div>

                <div id="bulkView">
                     <div class="bg-slate-800 rounded-lg p-4 mb-6">
                        <label for="bulkSearch" class="block mb-2 text-sm font-medium">Search Bulks</label>
                        <input type="text" id="bulkSearch" placeholder="Search by Bulk Name or Supplier..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                    </div>
                    <div class="bg-slate-800 rounded-lg overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th class="p-4 font-semibold text-white">Date</th>
                                    <th class="p-4 font-semibold text-white">Bulk Name / Ref No.</th>
                                    <th class="p-4 font-semibold text-white">Supplier</th>
                                    <th class="p-4 font-semibold text-white">Items</th>
                                    <th class="p-4 font-semibold text-white">Total Value (Rs)</th>
                                    <th class="p-4 font-semibold text-white">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bulkTableBody">
                                <tr><td colspan="6" class="text-center p-8 text-slate-400">Loading bulk purchases...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="summaryView" class="hidden">
                     <div class="bg-slate-800 rounded-lg p-4 mb-6">
                        <label for="summarySearch" class="block mb-2 text-sm font-medium">Search Item Summary</label>
                        <input type="text" id="summarySearch" placeholder="Search by Material Name..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                    </div>
                    <div class="bg-slate-800 rounded-lg overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th class="p-4 font-semibold text-white">Material Name</th>
                                    <th class="p-4 font-semibold text-white">Total Received</th>
                                    <th class="p-4 font-semibold text-white">Total Issued</th>
                                    <th class="p-4 font-semibold text-white">Total Value (Rs)</th>
                                    <th class="p-4 font-semibold text-white">Current Stock</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody">
                                <tr><td colspan="5" class="text-center p-8 text-slate-400">Loading stock summary...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="historyView" class="hidden">
                    <div class="bg-slate-800 rounded-lg p-4 mb-6 flex items-end gap-4">
                        <div class="flex-1">
                            <label for="historySearch" class="block mb-2 text-sm font-medium">Search All Transactions</label>
                            <input type="text" id="historySearch" placeholder="Search by material, supplier, issued to..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium">Filter by Type</label>
                            <div class="flex rounded-lg bg-slate-700 p-1">
                                <button id="historyFilterAll" class="history-filter-btn px-4 py-1.5 text-sm font-medium rounded-md bg-blue-600 text-white">All</button>
                                <button id="historyFilterIn" class="history-filter-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-300">In</button>
                                <button id="historyFilterOut" class="history-filter-btn px-4 py-1.5 text-sm font-medium rounded-md text-slate-300">Out</button>
                            </div>
                        </div>
                    </div>
                     <div class="bg-slate-800 rounded-lg overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th class="p-4 font-semibold text-white">Date</th>
                                    <th class="p-4 font-semibold text-white">Material / Details</th>
                                    <th class="p-4 font-semibold text-white">Type</th>
                                    <th class="p-4 font-semibold text-white">Source / Issued To</th>
                                    <th class="p-4 font-semibold text-white">Total Price (Rs)</th>
                                    <th class="p-4 font-semibold text-white">Bill</th>
                                    <th class="p-4 font-semibold text-white">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr><td colspan="7" class="text-center p-8 text-slate-400">Loading transaction history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="stockInModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-3xl" id="stockIn-modal-content">
             <h3 class="text-2xl font-bold text-white mb-6">Add Incoming Stock</h3>
             <form id="stockInForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="inBulkName" class="block mb-2 text-sm">Bulk Name / Ref No.</label>
                        <input id="inBulkName" type="text" class="w-full bg-slate-700 p-2.5 rounded-lg" placeholder="e.g. Weekly Order, Bill #123">
                    </div>
                     <div>
                        <label for="inSupplier" class="block mb-2 text-sm">Supplier</label>
                        <input id="inSupplier" type="text" class="w-full bg-slate-700 p-2.5 rounded-lg">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="inDate" class="block mb-2 text-sm">Date</label>
                    <input id="inDate" type="date" class="w-full bg-slate-700 p-2.5 rounded-lg" required>
                </div>
                <div class="border-t border-slate-700 mt-6 pt-4">
                    <h4 class="text-lg font-semibold mb-2">Items</h4>
                    <div id="materialItemsContainer" class="space-y-4">
                        </div>
                    <button type="button" id="addItemBtn" class="mt-4 flex items-center gap-2 text-blue-400 hover:text-blue-300 text-sm font-semibold"><i data-lucide="plus-circle" class="w-4 h-4"></i> Add Another Item</button>
                </div>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 border-t border-slate-700 pt-4">
                     <div>
                        <label for="inPaymentMethod" class="block mb-2 text-sm">Payment Method</label>
                        <select id="inPaymentMethod" class="w-full bg-slate-700 p-2.5 rounded-lg">
                            <option>Cash</option> <option>Check</option> <option>Bank Payment</option>
                        </select>
                    </div>
                     <div>
                        <label for="billFile" class="block mb-2 text-sm">Upload Bill</label>
                        <label for="billFile" class="file-input-label">Choose File</label>
                        <input type="file" id="billFile" class="file-input" accept="image/*">
                        <span id="billFileName" class="ml-4 text-slate-400 text-sm">No file chosen</span>
                    </div>
                </div>
                <div class="mt-6 text-right">
                    <p class="text-slate-400">Total Price: <span id="totalPrice" class="text-xl font-bold text-white">Rs 0.00</span></p>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" class="cancel-btn px-6 py-2 rounded-lg bg-slate-600">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 font-semibold">Save</button>
                </div>
             </form>
        </div>
    </div>

    <div id="stockOutModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-lg" id="stockOut-modal-content">
             <h3 id="stockOutModalTitle" class="text-2xl font-bold text-white mb-6">Issue Stock</h3>
             <form id="stockOutForm" data-doc-id="">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="outMaterialName" class="block mb-2 text-sm">Material Name</label>
                        <select id="outMaterialName" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select>
                    </div>
                     <div>
                        <label for="outQuantity" class="block mb-2 text-sm">Quantity</label>
                        <input id="outQuantity" type="number" min="1" class="w-full bg-slate-700 p-2.5 rounded-lg" required>
                         <p id="availableStockInfo" class="text-xs text-slate-400 mt-1 h-4"></p>
                    </div>
                     <div>
                        <label for="outDate" class="block mb-2 text-sm">Date</label>
                        <input id="outDate" type="date" class="w-full bg-slate-700 p-2.5 rounded-lg" required>
                    </div>
                     <div>
                        <label for="outIssuedTo" class="block mb-2 text-sm">Issued To</label>
                        <input id="outIssuedTo" type="text" class="w-full bg-slate-700 p-2.5 rounded-lg" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" class="cancel-btn px-6 py-2 rounded-lg bg-slate-600">Cancel</button>
                    <button type="submit" id="stockOutSubmitBtn" class="px-6 py-2 rounded-lg bg-blue-600 font-semibold">Issue</button>
                </div>
             </form>
        </div>
    </div>
    
    <div id="bulkItemsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-3xl max-h-[80vh] flex flex-col" id="bulkItems-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="bulkItemsTitle" class="text-2xl font-bold text-white">Bulk Items</h3>
                <button id="closeBulkItemsModalBtn" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-700 sticky top-0">
                        <tr>
                            <th class="p-3 font-semibold text-white">Material Name</th>
                            <th class="p-3 font-semibold text-white">Quantity Received</th>
                            <th class="p-3 font-semibold text-white">Price (Rs)</th>
                            <th class="p-3 font-semibold text-white">Total Available (All Bulks)</th>
                        </tr>
                    </thead>
                    <tbody id="bulkItemsTableBody">
                        </tbody>
                </table>
                 <p class="mt-4 text-sm text-slate-400">Click on an item row to see its full transaction history.</p>
            </div>
        </div>
    </div>

    <div id="stockDetailModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-2xl max-h-[80vh] flex flex-col" id="stockDetail-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="stockDetailTitle" class="text-2xl font-bold text-white">Material Details</h3>
                <button id="closeStockDetailModalBtn" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-700 sticky top-0">
                        <tr>
                            <th class="p-3 font-semibold text-white">Date</th>
                            <th class="p-3 font-semibold text-white">Type</th>
                            <th class="p-3 font-semibold text-white">Quantity</th>
                            <th class="p-3 font-semibold text-white">Source / Issued To</th>
                            <th class="p-3 font-semibold text-white">Price (Rs)</th>
                        </tr>
                    </thead>
                    <tbody id="stockDetailTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="billViewModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 rounded-lg p-4 w-full max-w-3xl max-h-[90vh] flex flex-col" id="bill-view-modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-white">Bill Viewer</h3><button id="closeBillViewModalBtn" class="text-slate-400 text-3xl">&times;</button></div>
            <div class="flex-1 overflow-auto"><img id="billImagePreview" src="" class="max-w-full h-auto mx-auto"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-all"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // *** HADAPU THANA (6): writeBatch import kala ***
        import { getFirestore, collection, addDoc, onSnapshot, doc, query, where, getDocs, deleteDoc, getDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // ... (firebaseConfig, IMGBB_API_KEY, app, db, auth, etc. remain the same) ...
        const firebaseConfig = {
             apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
            authDomain: "rsgweb-5f36d.firebaseapp.com",
            projectId: "rsgweb-5f36d",
            storageBucket: "rsgweb-5f36d.firebasestorage.app",
            messagingSenderId: "633023905515",
            appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };
        const IMGBB_API_KEY = "9960ed5927a4c5187a7b6dd2db60ecff";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;
        let allTransactions = [];
        let historyTypeFilter = 'All';

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');
        
        const tabBulk = document.getElementById('tabBulk');
        const tabSummary = document.getElementById('tabSummary');
        const tabHistory = document.getElementById('tabHistory');
        const bulkView = document.getElementById('bulkView');
        const summaryView = document.getElementById('summaryView');
        const historyView = document.getElementById('historyView');
        const allTabs = { tabBulk, tabSummary, tabHistory };
        const allViews = { bulkView, summaryView, historyView };

        const bulkTableBody = document.getElementById('bulkTableBody');
        const summaryTableBody = document.getElementById('summaryTableBody');
        const historyTableBody = document.getElementById('historyTableBody');
        const bulkSearchInput = document.getElementById('bulkSearch');
        const summarySearchInput = document.getElementById('summarySearch');
        const historySearchInput = document.getElementById('historySearch');
        const historyFilterBtns = document.querySelectorAll('.history-filter-btn');
        
        // Modals
        const stockInModal = document.getElementById('stockInModal');
        const stockOutModal = document.getElementById('stockOutModal');
        const addStockInBtn = document.getElementById('addStockInBtn');
        const addStockOutBtn = document.getElementById('addStockOutBtn');
        const cancelBtns = document.querySelectorAll('.cancel-btn');
        const stockInForm = document.getElementById('stockInForm');
        const stockOutForm = document.getElementById('stockOutForm');
        const materialItemsContainer = document.getElementById('materialItemsContainer');
        const addItemBtn = document.getElementById('addItemBtn');
        const totalPriceEl = document.getElementById('totalPrice');
        const billFileInput = document.getElementById('billFile');
        const billFileNameSpan = document.getElementById('billFileName');
        const outMaterialNameSelect = document.getElementById('outMaterialName');
        const availableStockInfo = document.getElementById('availableStockInfo');
        const stockOutModalTitle = document.getElementById('stockOutModalTitle');
        const stockOutSubmitBtn = document.getElementById('stockOutSubmitBtn');

        const bulkItemsModal = document.getElementById('bulkItemsModal');
        const bulkItemsTitle = document.getElementById('bulkItemsTitle');
        const bulkItemsTableBody = document.getElementById('bulkItemsTableBody');
        const closeBulkItemsModalBtn = document.getElementById('closeBulkItemsModalBtn');

        const stockDetailModal = document.getElementById('stockDetailModal');
        const stockDetailTitle = document.getElementById('stockDetailTitle');
        const stockDetailTableBody = document.getElementById('stockDetailTableBody');
        const closeStockDetailModalBtn = document.getElementById('closeStockDetailModalBtn');
        
        const billViewModal = document.getElementById('billViewModal');
        const closeBillViewModalBtn = document.getElementById('closeBillViewModalBtn');
        const billImagePreview = document.getElementById('billImagePreview');

        // --- Auth ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');
                listenForTransactions();
            } else {
                window.location.href = './index.html'; 
            }
        });
        
        signOutBtn.addEventListener('click', () => signOut(auth));

        // --- Tab Switching Logic ---
        function switchTab(activeTabId) {
            Object.values(allViews).forEach(view => view.classList.add('hidden'));
            Object.values(allTabs).forEach(tab => {
                tab.classList.remove('text-blue-400', 'border-blue-400');
                tab.classList.add('text-slate-400', 'border-transparent', 'hover:text-slate-300', 'hover:border-slate-300');
            });

            if (activeTabId === 'tabBulk') allViews.bulkView.classList.remove('hidden');
            if (activeTabId === 'tabSummary') allViews.summaryView.classList.remove('hidden');
            if (activeTabId === 'tabHistory') allViews.historyView.classList.remove('hidden');
            
            const activeTab = allTabs[activeTabId];
            if (activeTab) { 
                activeTab.classList.add('text-blue-400', 'border-blue-400');
                activeTab.classList.remove('text-slate-400', 'border-transparent');
            }
        }
        tabBulk.addEventListener('click', () => switchTab('tabBulk'));
        tabSummary.addEventListener('click', () => switchTab('tabSummary'));
        tabHistory.addEventListener('click', () => switchTab('tabHistory'));
        
        // --- Modals ---
        addStockInBtn.addEventListener('click', () => {
            stockInForm.reset();
            materialItemsContainer.innerHTML = '';
            addMaterialItemRow();
            document.getElementById('inDate').valueAsDate = new Date();
            stockInModal.classList.remove('hidden')
        });
        addStockOutBtn.addEventListener('click', () => {
            stockOutForm.reset();
            stockOutForm.dataset.docId = '';
            stockOutModalTitle.textContent = 'Issue Stock';
            stockOutSubmitBtn.textContent = 'Issue';
            availableStockInfo.textContent = '';
            document.getElementById('outDate').valueAsDate = new Date();
            populateMaterialSelect();
            stockOutModal.classList.remove('hidden');
        });
        cancelBtns.forEach(btn => btn.addEventListener('click', () => {
            stockInModal.classList.add('hidden');
            stockOutModal.classList.add('hidden');
            stockInForm.reset();
            stockOutForm.reset();
            availableStockInfo.textContent = '';
            materialItemsContainer.innerHTML = '';
            stockOutForm.dataset.docId = '';
        }));
         billFileInput.addEventListener('change', () => {
            billFileNameSpan.textContent = billFileInput.files[0]?.name || 'No file chosen';
        });

        // --- Bill Viewer ---
        const openBillViewModal = (url) => {
            billImagePreview.src = url;
            billViewModal.classList.remove('hidden');
        };
        const closeBillViewModal = () => billViewModal.classList.add('hidden');
        closeBillViewModalBtn.addEventListener('click', closeBillViewModal);
        billViewModal.addEventListener('click', (e) => { if(e.target === billViewModal) closeBillViewModal() });

        // --- Stock Detail (History) Modal ---
        closeStockDetailModalBtn.addEventListener('click', () => stockDetailModal.classList.add('hidden'));
        stockDetailModal.addEventListener('click', (e) => { if(e.target === stockDetailModal) stockDetailModal.classList.add('hidden') });
        
        // --- Bulk Items Modal Events ---
        closeBulkItemsModalBtn.addEventListener('click', () => bulkItemsModal.classList.add('hidden'));
        bulkItemsModal.addEventListener('click', (e) => { if(e.target === bulkItemsModal) bulkItemsModal.classList.add('hidden') });


        // --- History Table Click Handler (Edit/Delete) ---
        historyTableBody.addEventListener('click', async e => {
            const viewBtn = e.target.closest('.view-bill-btn');
            if (viewBtn) {
                e.preventDefault();
                openBillViewModal(viewBtn.dataset.url);
                return;
            }

            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn && currentUserId) {
                const docId = deleteBtn.dataset.id;
                if (confirm('Are you sure you want to delete this transaction? This will also delete the linked expense if applicable.')) { // Update confirmation message
                    try {
                        const materialDocRef = doc(db, `users/${currentUserId}/materials`, docId);
                        const materialDocSnap = await getDoc(materialDocRef);

                        // Check if it's Stock In and potentially linked
                        if (materialDocSnap.exists() && materialDocSnap.data().type === 'In' && (materialDocSnap.data().totalPrice > 0 || materialDocSnap.data().items?.some(i => i.price > 0))) {
                             const q = query(collection(db, `users/${currentUserId}/transactions`), where("materialDocId", "==", docId));
                             const expenseSnapshot = await getDocs(q);
                             
                             const batch = writeBatch(db); // Use a batch write
                             
                             // Delete linked expense(s) if found
                             expenseSnapshot.forEach(expenseDoc => {
                                 batch.delete(expenseDoc.ref); 
                             });
                             
                             // Delete the material transaction itself
                             batch.delete(materialDocRef);
                             
                             await batch.commit(); // Commit both deletes together
                             showToast('Transaction and linked expense deleted successfully.');

                        } else {
                            // If it's Stock Out or Stock In with no price, just delete the material doc
                            await deleteDoc(materialDocRef);
                            showToast('Transaction deleted successfully.');
                        }
                        
                    } catch (error) {
                        showToast(`Error deleting transaction: ${error.message}`, false);
                    }
                }
                return;
            }

            const editBtn = e.target.closest('.edit-btn');
            if (editBtn && currentUserId) {
                const docId = editBtn.dataset.id;
                const type = editBtn.dataset.type;
                if (type === 'Out') {
                    openEditStockOutModal(docId);
                } else {
                    alert('Editing "Stock In" transactions is complex. Please delete this entry (which will also remove the linked expense) and add it again if changes are needed.');
                }
                return;
            }
        });
        
        // --- Summary Table Click Handler (Open Item History Modal) ---
        summaryTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr.clickable-row'); 
            if (row && row.dataset.materialName) {
                const materialName = row.dataset.materialName;
                openStockDetailModal(materialName);
            }
        });

        // --- *** HADAPU THANA (7): Bulk Table delete handler logic eka update kala *** ---
        bulkTableBody.addEventListener('click', async e => {
            const deleteBtn = e.target.closest('.delete-bulk-btn');
            if (deleteBtn && currentUserId) {
                const docId = deleteBtn.dataset.id;
                 // Update confirmation message to include linked expense deletion
                if (confirm('Are you sure you want to delete this entire bulk purchase? This will ALSO delete the linked expense entry if one exists.')) { 
                    try {
                        const materialDocRef = doc(db, `users/${currentUserId}/materials`, docId);
                        const materialDocSnap = await getDoc(materialDocRef);
                        
                        const batch = writeBatch(db); // Use a batch for atomicity

                        // Check if it's linked and delete expense first if exists
                        if (materialDocSnap.exists() && (materialDocSnap.data().totalPrice > 0 || materialDocSnap.data().items?.some(i => i.price > 0))) {
                             const q = query(collection(db, `users/${currentUserId}/transactions`), where("materialDocId", "==", docId));
                             const expenseSnapshot = await getDocs(q);
                             expenseSnapshot.forEach(expenseDoc => {
                                 batch.delete(expenseDoc.ref); // Add expense deletion to batch
                             });
                        }
                        
                        // Add material doc deletion to batch
                        batch.delete(materialDocRef); 
                        
                        await batch.commit(); // Commit all deletions
                        showToast('Bulk purchase and linked expense deleted successfully.');

                    } catch (error) {
                        showToast(`Error deleting bulk purchase: ${error.message}`, false);
                        console.error("Error deleting bulk:", error); // Log error
                    }
                }
                return; 
            }

            const editBtn = e.target.closest('.edit-bulk-btn');
            if (editBtn && currentUserId) {
                 alert('Editing bulk purchases is complex. Please delete this entry (which will also remove the linked expense) and add it again if changes are needed.');
                 return; 
            }

            // Click on row cells (excluding the last action cell) opens the detail modal
            const cell = e.target.closest('td');
            if (cell && !cell.contains(deleteBtn) && !cell.contains(editBtn)) { // Check if click is not on buttons
                 const row = cell.closest('tr');
                 if (row && row.dataset.docId) {
                     const docId = row.dataset.docId;
                     openBulkItemsModal(docId);
                 }
            }
        });
        
        
        // --- Bulk Items Modal Click Handler (Open Item History Modal) ---
        bulkItemsTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (row && row.dataset.materialName) {
                const materialName = row.dataset.materialName;
                openStockDetailModal(materialName); 
            }
        });


        // --- Stock Detail (History) Modal Logic ---
        function openStockDetailModal(materialName) {
            stockDetailTitle.textContent = `${materialName} - Transaction Log`;
            stockDetailTableBody.innerHTML = '';

            const materialTransactions = allTransactions
                .filter(t => t.items && Array.isArray(t.items) && t.items.some(item => item.name === materialName))
                .sort((a, b) => a.date.toDate() - b.date.toDate()); 

            if (materialTransactions.length === 0) {
                stockDetailTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-slate-400">No history found for this item.</td></tr>`;
                stockDetailModal.classList.remove('hidden');
                return;
            }

            materialTransactions.forEach(t => {
                const item = t.items.find(i => i.name === materialName);
                if (!item) return;

                const row = stockDetailTableBody.insertRow();
                const typeClass = t.type === 'In' ? 'text-green-400' : 'text-red-400';
                
                row.innerHTML = `
                    <td class="p-3 border-b border-slate-700">${t.date && t.date.toDate ? t.date.toDate().toLocaleDateString() : 'Invalid Date'}</td>
                    <td class="p-3 border-b border-slate-700 font-semibold ${typeClass}">${t.type || 'N/A'}</td>
                    <td class="p-3 border-b border-slate-700">${t.type === 'In' ? '+' : '-'}${item.quantity || 0}</td>
                    <td class="p-3 border-b border-slate-700 text-sm">${t.type === 'In' ? (t.supplier || t.bulkName || 'N/A') : (t.issuedTo || 'N/A')}</td>
                    <td class="p-3 border-b border-slate-700 text-sm">${t.type === 'In' ? (item.price != null ? item.price.toFixed(2) : (t.totalPrice != null ? (t.totalPrice / (t.items.reduce((sum, i) => sum + (i.quantity || 0), 0) || 1)).toFixed(2) + ' (Avg)' : '0.00')) : 'N/A'}</td>
                `;
            });

            stockDetailModal.classList.remove('hidden');
        }
        
        // --- Bulk Items Modal Logic ---
        function openBulkItemsModal(docId) {
            const bulkTransaction = allTransactions.find(t => t.id === docId);
            if (!bulkTransaction) {
                showToast("Could not find bulk transaction.", false);
                return;
            }

            bulkItemsTitle.textContent = `Items in: ${bulkTransaction.bulkName || bulkTransaction.supplier || 'N/A'}`;
            bulkItemsTableBody.innerHTML = '';
            
            if (!bulkTransaction.items || !Array.isArray(bulkTransaction.items) || bulkTransaction.items.length === 0) {
                bulkItemsTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-400">No items found in this bulk purchase.</td></tr>`;
                bulkItemsModal.classList.remove('hidden');
                return;
            }

            bulkTransaction.items.forEach(item => {
                const row = bulkItemsTableBody.insertRow();
                row.className = 'clickable-row'; 
                row.dataset.materialName = item.name; 
                
                const totalAvailable = calculateCurrentStock(item.name);
                let stockClass = 'text-green-400';
                if (totalAvailable <= 0) stockClass = 'text-red-500';
                else if (totalAvailable <= 20) stockClass = 'text-yellow-500';

                row.innerHTML = `
                    <td class="p-3 border-b border-slate-700">${item.name || 'N/A'}</td>
                    <td class="p-3 border-b border-slate-700">${item.quantity || 0}</td>
                    <td class="p-3 border-b border-slate-700">${(item.price || 0).toFixed(2)}</td>
                    <td class="p-3 border-b border-slate-700 font-bold ${stockClass}">${totalAvailable}</td>
                `;
            });

            bulkItemsModal.classList.remove('hidden');
        }


        // --- Edit Stock Out Modal Logic ---
        async function openEditStockOutModal(docId) {
            try {
                const docRef = doc(db, `users/${currentUserId}/materials`, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    stockOutForm.reset();
                    await populateMaterialSelect(); 

                    if (data.items && Array.isArray(data.items) && data.items.length > 0) {
                        outMaterialNameSelect.value = data.items[0].name || '';
                        outQuantity.value = data.items[0].quantity || '';
                    }
                    
                    outDate.value = data.date && data.date.toDate ? data.date.toDate().toISOString().split('T')[0] : ''; 
                    outIssuedTo.value = data.issuedTo || '';
                    
                    stockOutForm.dataset.docId = docId;
                    stockOutModalTitle.textContent = 'Edit Issued Stock';
                    stockOutSubmitBtn.textContent = 'Update';
                    
                    outMaterialNameSelect.dispatchEvent(new Event('change'));
                    
                    stockOutModal.classList.remove('hidden');

                } else {
                    showToast('Error: Transaction not found.', false);
                }
            } catch (error) {
                showToast(`Error loading data: ${error.message}`, false);
            }
        }
        

        // --- Toast ---
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.className = `fixed bottom-10 right-10 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-all ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        };
        
        // --- Firestore & Data Handling ---
        const uploadFile = async (file) => {
             if (!file) return null;
            const formData = new FormData();
            formData.append('image', file);
            try { 
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                if (!response.ok) { 
                    throw new Error(`Upload failed with status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success) return result.data.url;
                throw new Error(result.error?.message || 'Unknown upload error'); 
            } catch (error) {
                console.error('Error uploading file:', error);
                showToast(`File upload failed: ${error.message}`, false);
                return null;
            }
        };

        stockInForm.addEventListener('submit', async e => {
            e.preventDefault();
            const billUrl = await uploadFile(billFileInput.files[0]);
            
            const items = [];
            let totalPrice = 0;
            let formIsValid = true; 
            document.querySelectorAll('.material-item-row').forEach(row => {
                const nameInput = row.querySelector('.material-name');
                const quantityInput = row.querySelector('.material-quantity');
                const priceInput = row.querySelector('.material-price');

                const name = nameInput.value.trim(); 
                const quantity = parseInt(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                if(!name || quantity <= 0) { 
                    formIsValid = false;
                    nameInput.classList.add('border-red-500'); 
                    quantityInput.classList.add('border-red-500');
                } else {
                     nameInput.classList.remove('border-red-500');
                     quantityInput.classList.remove('border-red-500');
                     items.push({ name, quantity, price });
                     totalPrice += price;
                }
            });

            if (!formIsValid) {
                 showToast('Please ensure all items have a name and quantity greater than 0.', false);
                 return;
             }

            if (items.length === 0) {
                showToast('Please add at least one valid material item.', false);
                return;
            }
            
            const dateValue = document.getElementById('inDate').value;
             if (!dateValue) {
                showToast('Please select a valid date.', false);
                return;
            }

            const data = {
                date: new Date(dateValue),
                type: 'In',
                bulkName: document.getElementById('inBulkName').value.trim(), 
                supplier: document.getElementById('inSupplier').value.trim(),
                items: items,
                totalPrice: totalPrice,
                paymentMethod: document.getElementById('inPaymentMethod').value,
                billUrl: billUrl
            };
            
            try { 
                const materialDocRef = await addDoc(collection(db, `users/${currentUserId}/materials`), data);

                if(totalPrice > 0) {
                     const expenseData = {
                        date: data.date,
                        description: `Stock Purchase: ${data.bulkName || data.supplier || 'N/A'}`,
                        category: 'Materials',
                        type: 'Expense',
                        amount: totalPrice,
                        paymentMethod: data.paymentMethod,
                        billUrl: billUrl,
                        materialDocId: materialDocRef.id 
                     };
                     await addDoc(collection(db, `users/${currentUserId}/transactions`), expenseData);
                }

                showToast('Stock added & expense recorded!');
                stockInForm.reset();
                materialItemsContainer.innerHTML = '';
                 addMaterialItemRow(); 
                billFileNameSpan.textContent = 'No file chosen';
                stockInModal.classList.add('hidden');
            } catch (error) {
                 console.error("Error adding stock:", error);
                 showToast(`Error saving stock: ${error.message}`, false);
            }
        });
        
        stockOutForm.addEventListener('submit', async e => {
            e.preventDefault();
            const docId = stockOutForm.dataset.docId;
            
            const materialName = document.getElementById('outMaterialName').value;
            const quantityToIssue = parseInt(document.getElementById('outQuantity').value);
            const issuedTo = document.getElementById('outIssuedTo').value.trim();
             const dateValue = document.getElementById('outDate').value;

            if (!materialName || !quantityToIssue || quantityToIssue <= 0 || !issuedTo || !dateValue) {
                 showToast('Please fill all fields with valid values.', false);
                 return;
             }

            const currentStock = calculateCurrentStock(materialName);
            
            let originalQuantity = 0;
            if (docId) {
                const originalTransaction = allTransactions.find(t => t.id === docId);
                if (originalTransaction && originalTransaction.items && originalTransaction.items.length > 0) {
                    originalQuantity = originalTransaction.items[0].quantity || 0;
                }
            }

            if(quantityToIssue > (currentStock + originalQuantity)) {
                showToast('Cannot issue more than available stock.', false);
                return;
            }

             const data = {
                date: new Date(dateValue),
                items: [{
                    name: materialName,
                    quantity: quantityToIssue,
                }],
                type: 'Out',
                issuedTo: issuedTo,
            };

            try {
                if (docId) {
                    await updateDoc(doc(db, `users/${currentUserId}/materials`, docId), data);
                    showToast('Stock issue updated!');
                } else {
                    await addDoc(collection(db, `users/${currentUserId}/materials`), data);
                    showToast('Stock issued!');
                }
                
                stockOutForm.reset();
                availableStockInfo.textContent = '';
                stockOutForm.dataset.docId = '';
                stockOutModal.classList.add('hidden');

            } catch (error) {
                 console.error("Error saving stock issue:", error);
                 showToast(`Error saving data: ${error.message}`, false);
            }
        });

        // --- Dynamic Item Rows for Stock In ---
        function addMaterialItemRow(){
            const div = document.createElement('div');
            div.className = 'material-item-row grid grid-cols-12 gap-2 items-center';
            div.innerHTML = `
                <input type="text" class="material-name col-span-5 bg-slate-600 border border-slate-700 p-2 rounded-lg text-sm" placeholder="Material Name" required>
                <input type="number" min="1" class="material-quantity col-span-3 bg-slate-600 border border-slate-700 p-2 rounded-lg text-sm" placeholder="Quantity" required>
                <input type="number" step="0.01" min="0" class="material-price col-span-3 bg-slate-600 border border-slate-700 p-2 rounded-lg text-sm" placeholder="Total Price">
                <button type="button" class="remove-item-btn col-span-1 text-red-500 hover:text-red-400 p-2 flex justify-center items-center"><i data-lucide="minus-circle" class="w-5 h-5 pointer-events-none"></i></button>
            `;
            materialItemsContainer.appendChild(div);
            lucide.createIcons();
        }

        addItemBtn.addEventListener('click', addMaterialItemRow);

        materialItemsContainer.addEventListener('click', e => {
            const removeButton = e.target.closest('.remove-item-btn');
            if(removeButton){
                if(materialItemsContainer.children.length > 1) {
                    removeButton.closest('.material-item-row').remove();
                    updateTotalPrice();
                } else {
                    showToast('You must have at least one item.', false);
                }
            }
        });
        
        materialItemsContainer.addEventListener('input', updateTotalPrice);

        function updateTotalPrice() {
            let total = 0;
             document.querySelectorAll('.material-item-row').forEach(row => {
                const price = parseFloat(row.querySelector('.material-price').value) || 0;
                total += price;
            });
            totalPriceEl.textContent = `Rs ${total.toFixed(2)}`;
        }
        
        
        function listenForTransactions(){
            if (!currentUserId) return; // Add guard clause
            onSnapshot(collection(db, `users/${currentUserId}/materials`), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                applyFilters(); 
            }, (error) => {
                console.error("Error listening to transactions: ", error);
                summaryTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-red-400">Error loading data. Check console and Firebase Rules.</td></tr>`;
                bulkTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-400">Error loading data. Check console and Firebase Rules.</td></tr>`;
                historyTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-red-400">Error loading data. Check console and Firebase Rules.</td></tr>`;
                showToast("Error loading data from Firebase. Check connection and rules.", false); 
            });
        }
        
        function applyFilters() {
            try {
                renderBulkTable();
                renderSummaryTable();
                renderHistoryTable();
            } catch (error) {
                console.error("Error during rendering:", error);
                showToast("An error occurred while displaying data.", false);
            }
        }
        
        // Filter Event Listeners
        bulkSearchInput.addEventListener('input', renderBulkTable);
        summarySearchInput.addEventListener('input', renderSummaryTable);
        historySearchInput.addEventListener('input', renderHistoryTable);

        historyFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                historyFilterBtns.forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('text-slate-300');
                });
                btn.classList.add('bg-blue-600', 'text-white');
                btn.classList.remove('text-slate-300');
                historyTypeFilter = btn.textContent;
                renderHistoryTable();
            });
        });
        
        const calculateCurrentStock = (materialName) => {
             let totalIn = 0;
             let totalOut = 0;
             allTransactions.forEach(t => {
                if (t.items && Array.isArray(t.items)) {
                    t.items.forEach(item => {
                        if(item.name && item.name === materialName) { 
                            if (t.type === 'In') totalIn += (item.quantity || 0);
                            else totalOut += (item.quantity || 0);
                        }
                    });
                }
            });
            return totalIn - totalOut;
        };

        // Render Bulk Purchases Table
        function renderBulkTable() {
            const searchTerm = bulkSearchInput.value.toLowerCase();
            let bulkTransactions = allTransactions.filter(t => t.type === 'In'); 
            
            if (searchTerm) {
                bulkTransactions = bulkTransactions.filter(t => 
                    (t.bulkName && t.bulkName.toLowerCase().includes(searchTerm)) ||
                    (t.supplier && t.supplier.toLowerCase().includes(searchTerm))
                );
            }

            bulkTransactions.sort((a,b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0)); 
            
            bulkTableBody.innerHTML = '';
            if (bulkTransactions.length === 0) {
                bulkTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-400">No bulk purchases found. Add incoming stock to get started.</td></tr>`;
                return;
            }

            bulkTransactions.forEach(t => {
                const row = bulkTableBody.insertRow();
                row.dataset.docId = t.id; 
                
                const bulkName = t.bulkName || t.supplier || 'N/A';
                const itemsCount = (t.items && Array.isArray(t.items)) ? t.items.length : 0;
                const dateString = t.date && t.date.toDate ? t.date.toDate().toLocaleDateString() : 'Invalid Date';

                row.innerHTML = `
                    <td class="p-4 align-top clickable-row">${dateString}</td>
                    <td class="p-4 align-top font-bold text-white clickable-row">${bulkName}</td>
                    <td class="p-4 align-top clickable-row">${t.supplier || 'N/A'}</td>
                    <td class="p-4 align-top clickable-row">${itemsCount}</td>
                    <td class="p-4 align-top text-blue-300 clickable-row">${(t.totalPrice || 0).toFixed(2)}</td>
                    <td class="p-4 align-top">
                         <div class="flex gap-2">
                            <button data-id="${t.id}" class="edit-bulk-btn text-blue-400 hover:text-blue-300"><i data-lucide="edit" class="w-5 h-5 pointer-events-none"></i></button>
                            <button data-id="${t.id}" class="delete-bulk-btn text-red-400 hover:text-red-300"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                        </div>
                    </td>
                `;
            });
             lucide.createIcons(); 
        }

        // Render Item Summary Table
        function renderSummaryTable() {
            const searchTerm = summarySearchInput.value.toLowerCase();
            let transactionsToSummarize = allTransactions;
            if (searchTerm) {
                 transactionsToSummarize = transactionsToSummarize.filter(t => 
                    (t.items && Array.isArray(t.items) && t.items.some(item => item.name && item.name.toLowerCase().includes(searchTerm)))
                );
            }

            const summary = {};
            transactionsToSummarize.forEach(t => {
                if (t.items && Array.isArray(t.items)) {
                    t.items.forEach(item => {
                         if(item.name) { 
                            if(!summary[item.name]) {
                                summary[item.name] = { totalIn: 0, totalOut: 0, totalCost: 0 };
                            }
                            if (t.type === 'In') {
                                summary[item.name].totalIn += (item.quantity || 0);
                                summary[item.name].totalCost += (item.price || 0);
                            } else {
                                summary[item.name].totalOut += (item.quantity || 0);
                            }
                        }
                    });
                }
            });
            
            summaryTableBody.innerHTML = '';
            if (Object.keys(summary).length === 0) {
                summaryTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-400">No materials found.</td></tr>`;
                return;
            }
            
            const sortedSummary = Object.keys(summary).sort();

            for(const name of sortedSummary) {
                const item = summary[name];
                const currentStock = item.totalIn - item.totalOut;
                const row = summaryTableBody.insertRow();
                row.className = 'clickable-row'; 
                row.dataset.materialName = name; 
                
                let stockClass = 'text-green-400';
                if (currentStock <= 0) {
                    stockClass = 'text-red-500';
                } else if (currentStock <= 20) {
                    stockClass = 'text-yellow-500';
                }

                row.innerHTML = `
                    <td class="p-4 font-bold text-lg">${name}</td>
                    <td class="p-4 text-xl font-semibold text-green-400">${item.totalIn}</td>
                    <td class="p-4 text-xl font-semibold text-red-400">${item.totalOut}</td>
                    <td class="p-4 text-xl font-semibold text-blue-300">${item.totalCost.toFixed(2)}</td>
                    <td class="p-4 text-2xl font-extrabold ${stockClass}">${currentStock}</td>
                `;
            }
            lucide.createIcons();
        }
        
        // Render All Transactions (History) Table
        function renderHistoryTable() {
            const searchTerm = historySearchInput.value.toLowerCase();
            let filtered = [...allTransactions];
            
            filtered.sort((a,b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0));

            if (historyTypeFilter !== 'All') {
                filtered = filtered.filter(t => t.type === historyTypeFilter);
            }

            if(searchTerm){
                 filtered = filtered.filter(t => 
                    (t.items && Array.isArray(t.items) && t.items.some(item => item.name && item.name.toLowerCase().includes(searchTerm))) || 
                    (t.supplier && t.supplier.toLowerCase().includes(searchTerm)) ||
                    (t.issuedTo && t.issuedTo.toLowerCase().includes(searchTerm)) ||
                    (t.bulkName && t.bulkName.toLowerCase().includes(searchTerm)) 
                );
            }

            historyTableBody.innerHTML = '';
             if (filtered.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-slate-400">No matching transactions found.</td></tr>`;
                return;
            }

            filtered.forEach(t => {
                const row = historyTableBody.insertRow();
                const typeClass = t.type === 'In' ? 'text-green-400' : 'text-red-400';
                
                const itemsHtml = (t.items && Array.isArray(t.items)) 
                    ? t.items.map(item => `<div>${item.name || 'Unnamed'} (Qty: ${item.quantity || 0})</div>`).join('')
                    : '<span class="text-red-500">Error: No items found</span>';
                
                 const dateString = t.date && t.date.toDate ? t.date.toDate().toLocaleDateString() : 'Invalid Date'; 

                row.innerHTML = `
                    <td class="p-4 align-top">${dateString}</td>
                    <td class="p-4 text-sm align-top">${itemsHtml}</td>
                    <td class="p-4 font-semibold align-top ${typeClass}">${t.type || 'N/A'}</td>
                    <td class="p-4 align-top">${t.type === 'In' ? (t.bulkName || t.supplier || 'N/A') : (t.issuedTo || 'N/A')}</td>
                    <td class="p-4 align-top">${t.totalPrice != null ? t.totalPrice.toFixed(2) : 'N/A'}</td> 
                    <td class="p-4 align-top">${t.billUrl ? `<button data-url="${t.billUrl}" class="view-bill-btn text-blue-400 hover:underline">View Bill</button>` : 'N/A'}</td>
                    <td class="p-4 align-top">
                        <div class="flex gap-2">
                            <button data-id="${t.id}" data-type="${t.type}" class="edit-btn text-blue-400 hover:text-blue-300"><i data-lucide="edit" class="w-5 h-5 pointer-events-none"></i></button>
                            <button data-id="${t.id}" class="delete-btn text-red-400 hover:text-red-300"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                        </div>
                    </td>
                `;
            });
            lucide.createIcons();
        }
        
        // Populate Material Select for Stock Out
        async function populateMaterialSelect() {
            let materialNames = new Set();
            
            let dataToUse = allTransactions;
            if (dataToUse.length === 0) {
                 try {
                     const querySnapshot = await getDocs(collection(db, `users/${currentUserId}/materials`));
                     dataToUse = querySnapshot.docs.map(doc => doc.data());
                 } catch (error) {
                      console.error("Error fetching materials for dropdown:", error);
                      showToast("Error loading material list for issuing.", false);
                      return; 
                 }
            }

            dataToUse.forEach(t => {
                if (t.items && Array.isArray(t.items)) {
                    t.items.forEach(item => {
                         if (item.name) materialNames.add(item.name); 
                     })
                }
            });

            const select = document.getElementById('outMaterialName');
            select.innerHTML = '<option value="" disabled selected>Select Material</option>';
            
            const sortedNames = Array.from(materialNames).sort();

            sortedNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        // Update Available Stock Info on Select Change
        outMaterialNameSelect.addEventListener('change', (e) => {
            const selectedMaterial = e.target.value;
            const docId = stockOutForm.dataset.docId;

            if (selectedMaterial) {
                let currentStock = calculateCurrentStock(selectedMaterial);
                
                if (docId) {
                    const originalTransaction = allTransactions.find(t => t.id === docId);
                    if (originalTransaction && originalTransaction.items && originalTransaction.items.length > 0 && originalTransaction.items[0].name === selectedMaterial) {
                        currentStock += (originalTransaction.items[0].quantity || 0);
                    }
                }
                
                availableStockInfo.textContent = `Available: ${currentStock}`;
            } else {
                availableStockInfo.textContent = '';
            }
        });

        lucide.createIcons(); // Initial icon render

    </script>
</body>
</html>