<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Schedule - Property MS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 400px;
        }
        .day-column {
            min-height: 120px;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans">

    <div id="app-container" class="flex h-screen hidden">
        <aside class="w-64 bg-slate-800 p-6 flex-shrink-0 flex flex-col justify-between">
            <div>
                <div class="flex items-center gap-3 mb-10">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i data-lucide="building-2" class="text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-white">Property MS</h1>
                </div>
 <nav class="flex flex-col gap-2">
                   <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
                   <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="users"></i><span>Staff Members</span></a>
                    <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Staff Schedule</span></a>
                   <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="contact"></i><span>Customers</span></a>
                   <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="home"></i><span>Properties</span></a>
                   <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="siren"></i><span>Income/Expenses</span></a>
                   <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="boxes"></i><span>Materials Stock</span></a>
                   <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="car"></i><span>Vehicles</span></a>
                   <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Schedule</span></a>
                   <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-check-2"></i><span>Agreements</span></a>
                   <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="key-round"></i><span>App Access</span></a>
                   <a href="./agreement_generator.html" class="nav-link bg-slate-700 text-white flex items-center gap-3 px-4 py-2 rounded-lg transition"><i data-lucide="file-text"></i><span>Proposal Gen</span></a>

                </nav>
            </div>
            <div>
                 <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2 mb-4 rounded-lg transition bg-slate-700 hover:bg-red-600 text-white">
                    <i data-lucide="log-out"></i><span>Sign Out</span>
                </button>
                <div class="text-xs text-slate-500">
                    <p>&copy; 2025 Property MS. All rights reserved.</p>
                    <p class="mt-1">User ID: <span id="userId" class="font-mono">Loading...</span></p>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto flex flex-col">
            <section id="page-staff-schedule" class="page flex-1 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Staff Work Schedule</h2>
                </div>

                <div class="bg-slate-800 rounded-lg p-4 mb-6 flex items-end gap-4">
                     <div class="flex-1">
                        <label for="staffSearchInput" class="block mb-2 text-sm font-medium">Search Staff</label>
                        <input type="text" id="staffSearchInput" placeholder="Type name to search..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5 mb-2">
                        
                        <label for="staffSelect" class="block mb-2 text-sm font-medium">Select Staff Member</label>
                        <select id="staffSelect" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                            <option value="">Loading staff...</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="prevWeekBtn" class="p-2.5 rounded-md bg-slate-700 hover:bg-slate-600"><i data-lucide="chevron-left"></i></button>
                        <button id="todayWeekBtn" class="px-4 py-2.5 rounded-md bg-slate-700 hover:bg-slate-600 text-sm">This Week</button>
                        <button id="nextWeekBtn" class="p-2.5 rounded-md bg-slate-700 hover:bg-slate-600"><i data-lucide="chevron-right"></i></button>
                    </div>
                </div>
                
                <h3 id="weekRangeDisplay" class="text-xl font-semibold text-white mb-4 text-center"></h3>

                <div class="flex-1 flex flex-col bg-slate-800 rounded-lg overflow-hidden">
                    <div id="weekGridHeader" class="week-grid border-b border-slate-700" style="min-height: auto;">
                    </div>
                    <div id="weekGridBody" class="week-grid flex-1 overflow-y-auto">
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="workModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-lg transform transition-all scale-95 opacity-0" id="work-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="workModalTitle" class="text-2xl font-bold text-white">Add Work</h3>
                <button id="closeWorkModalBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <form id="workForm">
                <input type="hidden" id="workDocId">
                
                <div class="mb-4">
                    <label for="taskTitle" class="block mb-2 text-sm font-medium">Work / Task Title</label>
                    <input type="text" id="taskTitle" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" placeholder="e.g., Clean Block A, Mow Lawn" required>
                </div>
                
                <div class="mb-4">
                    <label for="workCategory" class="block mb-2 text-sm font-medium">Work Category</label>
                    <select id="workCategory" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Select Category</option>
                        <option value="Condominium">Condominium</option>
                        <option value="Flat">Flat</option>
                        <option value="Garden">Garden</option>
                        <option value="Gym">Gym</option>
                        <option value="Pool">Pool</option>
                        <option value="Other">Other</option>
                        <option value="Hotel B&B">Hotel B&B</option>
                        <option value="Staff">Staff (Office)</option>
                        <option value="Agency">Agency</option>
                        <option value="Laundry">Laundry</option>
                    </select>
                </div>
                
                <div id="flatsDropdownWrapper" class="mb-4 hidden">
                    <label for="flatsSelect" class="block mb-2 text-sm font-medium">Select Condominium (from plats-83345)</label>
                    <select id="flatsSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div id="propertyDropdownWrapper" class="mb-4 hidden">
                    <label for="propertySelect" class="block mb-2 text-sm font-medium">Select Property</label>
                    <select id="propertySelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="taskDate" class="block mb-2 text-sm font-medium">Date</label>
                        <input type="date" id="taskDate" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                    </div>
                     <div>
                        <label for="taskTime" class="block mb-2 text-sm font-medium">Time</label>
                        <input type="time" id="taskTime" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="taskDescription" class="block mb-2 text-sm font-medium">Description / Notes</label>
                    <textarea id="taskDescription" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" rows="3" placeholder="Add any extra details..."></textarea>
                </div>

                <div class="flex justify-between items-center mt-8">
                     <div>
                        <button type="button" id="deleteWorkBtn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold hidden">Delete</button>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancelWorkModalBtn" class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-700">Cancel</button>
                        <button type="submit" id="submitWorkBtn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold flex items-center">
                            <span id="submitWorkBtnText">Save</span>
                            <div id="submitWorkSpinner" class="loader w-5 h-5 ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="flatsLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60]">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-sm transform transition-all scale-95" id="flats-login-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Flats Database Login</h3>
                <button id="closeFlatsLoginModalBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <p class="text-sm text-slate-400 mb-6">Please log in to the 'plats-83345' admin account to load flats.</p>
            <form id="flatsLoginForm">
                <div class="mb-4">
                    <label for="flatsAdminEmail" class="block mb-2 text-sm font-medium">Admin Email</label>
                    <input type="email" id="flatsAdminEmail" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                </div>
                <div class="mb-6">
                    <label for="flatsAdminPassword" class="block mb-2 text-sm font-medium">Admin Password</label>
                    <input type="password" id="flatsAdminPassword" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                </div>
                <p id="flatsLoginError" class="text-red-400 text-sm mb-4"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelFlatsLoginModalBtn" class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-700">Cancel</button>
                    <button type="submit" id="submitFlatsLoginBtn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold flex items-center">
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, updateDoc, where, query, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- Main App Config (rsgweb-5f36d) ---
        const firebaseConfig = {
             apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
            authDomain: "rsgweb-5f36d.firebaseapp.com",
            projectId: "rsgweb-5f36d",
            storageBucket: "rsgweb-5f36d.firebasestorage.app",
            messagingSenderId: "633023905515",
            appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };
        
        // --- Flats App Config (plats-83345) ---
        const flatsFirebaseConfig = {
            apiKey: "AIzaSyAxyGsVS9cuuv2bkwWKcj3ZgQPzIA5T15w",
            authDomain: "plats-83345.firebaseapp.com",
            projectId: "plats-83345",
            storageBucket: "plats-83345.appspot.com",
            messagingSenderId: "619656775053",
            appId: "1:619656775053:web:25249b178c03afba52e9c4",
        };

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const flatsApp = initializeApp(flatsFirebaseConfig, "flatsApp");
        const flatsDb = getFirestore(flatsApp);
        const flatsAuth = getAuth(flatsApp); 

        let currentUserId = null;
        let allStaff = [];
        let allStaffWork = [];
        let loadedFlats = [];
        let loadedProperties = []; // *** ALUTH VARIABLE EKA ***
        let currentWeekStart = new Date();
        let isFlatsAdminLoggedIn = false; 

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');
        const staffSelect = document.getElementById('staffSelect');
        const staffSearchInput = document.getElementById('staffSearchInput');
        const weekGridHeader = document.getElementById('weekGridHeader');
        const weekGridBody = document.getElementById('weekGridBody');
        const weekRangeDisplay = document.getElementById('weekRangeDisplay');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const todayWeekBtn = document.getElementById('todayWeekBtn');

        // Work Modal
        const workModal = document.getElementById('workModal');
        const workModalContent = document.getElementById('work-modal-content');
        const workModalTitle = document.getElementById('workModalTitle');
        const closeWorkModalBtn = document.getElementById('closeWorkModalBtn');
        const cancelWorkModalBtn = document.getElementById('cancelWorkModalBtn');
        const workForm = document.getElementById('workForm');
        const deleteWorkBtn = document.getElementById('deleteWorkBtn');
        const submitWorkBtn = document.getElementById('submitWorkBtn');
        const submitWorkBtnText = document.getElementById('submitWorkBtnText');
        const submitWorkSpinner = document.getElementById('submitWorkSpinner');
        const workCategorySelect = document.getElementById('workCategory');
        
        // Dropdown wrappers
        const flatsDropdownWrapper = document.getElementById('flatsDropdownWrapper');
        const flatsSelect = document.getElementById('flatsSelect');
        const propertyDropdownWrapper = document.getElementById('propertyDropdownWrapper'); // *** ALUTH ELEMENT EKA ***
        const propertySelect = document.getElementById('propertySelect'); // *** ALUTH ELEMENT EKA ***
        
        // Flats Login Modal
        const flatsLoginModal = document.getElementById('flatsLoginModal');
        const flatsLoginModalContent = document.getElementById('flats-login-modal-content');
        const flatsLoginForm = document.getElementById('flatsLoginForm');
        const flatsLoginError = document.getElementById('flatsLoginError');
        const closeFlatsLoginModalBtn = document.getElementById('closeFlatsLoginModalBtn');
        const cancelFlatsLoginModalBtn = document.getElementById('cancelFlatsLoginModalBtn');

        // --- Date Helper ---
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 0);
            return new Date(d.setDate(diff));
        }
        
        // --- Auth ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');
                currentWeekStart = getStartOfWeek(new Date());
                listenForStaff();
                listenForWorkSchedule();
            } else {
                window.location.href = './index.html';
            }
        });
        
        onAuthStateChanged(flatsAuth, (user) => {
            isFlatsAdminLoggedIn = !!user; 
        });
        
        signOutBtn.addEventListener('click', () => {
            signOut(auth); 
            if (isFlatsAdminLoggedIn) {
                signOut(flatsAuth); 
            }
        });
        
        // --- Data Loading ---
        function listenForStaff() {
            if(!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/staff`), snapshot => {
                allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allStaff.sort((a, b) => a.name.localeCompare(b.name));
                filterStaffDropdown();
                renderWeekGrid();
            });
        }
        
        function listenForWorkSchedule() {
            if(!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/staff_work`), snapshot => {
                allStaffWork = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWeekGrid();
            });
        }
        
        // Wena DB eken flats load kirima
        async function loadFlatsFromExternalDB() {
            if (loadedFlats.length > 0) {
                populateFlatsDropdown();
                return;
            }
            
            flatsSelect.innerHTML = '<option value="">Loading flats...</option>';
            try {
                const q = query(collection(flatsDb, "condominiums"));
                const querySnapshot = await getDocs(q);
                loadedFlats = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateFlatsDropdown();
            } catch (err) {
                console.error("Error loading flats from external DB:", err);
                showToast("Error loading flats list.", false);
                flatsSelect.innerHTML = '<option value="">Error loading</option>';
            }
        }
        
        function populateFlatsDropdown() {
            const currentVal = flatsSelect.value;
            flatsSelect.innerHTML = '<option value="">-- Select a Flat --</option>';
            loadedFlats.sort((a, b) => (a.condominiumName || 'Z').localeCompare(b.condominiumName || 'Z'));
            loadedFlats.forEach(flat => {
                const option = document.createElement('option');
                option.value = flat.id;
                option.textContent = flat.condominiumName || 'Unnamed Flat';
                flatsSelect.appendChild(option);
            });
            flatsSelect.value = currentVal;
        }

        // *** ALUTH FUNCTION EKA - Main DB eken properties load kirima ***
        async function loadGenericProperties(category) {
            propertySelect.innerHTML = '<option value="">Loading items...</option>';
            if (!currentUserId) return;

            try {
                // Main DB eken (db) properties collection eka query karanna
                const q = query(collection(db, `users/${currentUserId}/properties`), where("category", "==", category));
                const querySnapshot = await getDocs(q);
                
                loadedProperties = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateGenericPropertyDropdown();
            } catch (err) {
                console.error("Error loading generic properties:", err);
                showToast(`Error loading ${category} list.`, false);
                propertySelect.innerHTML = '<option value="">Error loading</option>';
            }
        }

        // *** ALUTH HELPER FUNCTION EKA - Aluth dropdown eka populate kirima ***
        function populateGenericPropertyDropdown() {
            const currentVal = propertySelect.value;
            propertySelect.innerHTML = '<option value="">-- Select a Property --</option>';
            
            loadedProperties.sort((a, b) => a.name.localeCompare(b.name));
            
            if(loadedProperties.length === 0) {
                 propertySelect.innerHTML = '<option value="">No items found for this category</option>';
                 return;
            }

            loadedProperties.forEach(prop => {
                const option = document.createElement('option');
                option.value = prop.id;
                option.textContent = prop.name; // 'properties.html' eke 'Name / Number' eka
                propertySelect.appendChild(option);
            });
            propertySelect.value = currentVal;
        }


        // --- Week Grid Rendering (MODIFIED) ---
        function renderWeekGrid() {
            const selectedStaffId = staffSelect.value;
            weekGridHeader.innerHTML = '';
            weekGridBody.innerHTML = '';
            
            const startDate = new Date(currentWeekStart);
            startDate.setHours(0,0,0,0);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            weekRangeDisplay.textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            
            const weekWork = allStaffWork.filter(work => {
                if (work.staffId !== selectedStaffId) return false;
                const workDate = work.date.toDate();
                workDate.setHours(0,0,0,0);
                return workDate >= startDate && workDate <= endDate;
            });

            for (let i = 0; i < 7; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                const dayString = day.toISOString().split('T')[0];
                
                const headerEl = document.createElement('div');
                headerEl.className = 'p-4 text-center';
                headerEl.innerHTML = `
                    <div class="font-bold text-white">${day.toLocaleString('default', { weekday: 'short' })}</div>
                    <div class="text-sm text-slate-400">${day.getDate()}</div>
                `;
                weekGridHeader.appendChild(headerEl);
                
                const bodyEl = document.createElement('div');
                bodyEl.className = 'day-column border-t border-l border-slate-700 p-2 overflow-y-auto';
                
                const tasksForDay = weekWork
                    .filter(work => work.date.toDate().toISOString().split('T')[0] === dayString)
                    .sort((a,b) => a.date.toDate() - b.date.toDate());
                    
                tasksForDay.forEach(task => {
                    const taskTime = task.date.toDate().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    const taskEl = document.createElement('div');
                    taskEl.className = 'bg-slate-700 p-2 rounded-md mb-2 cursor-pointer hover:bg-slate-600';
                    taskEl.dataset.id = task.id;
                    taskEl.addEventListener('click', () => openWorkModal(task.id));
                    
                    // *** WENAS KALA: 'flatName' or 'propertyName' pennanna ***
                    const locationName = task.propertyName || task.flatName;

                    taskEl.innerHTML = `
                        <div class="font-bold text-sm">${task.taskTitle}</div>
                        <div class="text-xs text-slate-300">${task.workCategory || ''}</div>
                        ${locationName ? `<div class="text-xs text-cyan-400 mt-1"><i data-lucide="map-pin" class="w-3 h-3 inline-block mr-1"></i>${locationName}</div>` : ''}
                        <div class="text-xs text-blue-400 mt-1">${taskTime}</div>
                    `;
                    bodyEl.appendChild(taskEl);
                });
                
                if (selectedStaffId) {
                    const addTaskBtn = document.createElement('button');
                    addTaskBtn.className = 'w-full text-center p-2 rounded-md bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 transition';
                    addTaskBtn.innerHTML = `<i data-lucide="plus" class="w-4 h-4 inline-block"></i> Add`;
                    addTaskBtn.dataset.date = dayString;
                    addTaskBtn.addEventListener('click', () => openWorkModal(null, dayString));
                    bodyEl.appendChild(addTaskBtn);
                }
                weekGridBody.appendChild(bodyEl);
            }
            lucide.createIcons();
        }
        
        // --- Week Navigation & Filters (wenas wela na) ---
        prevWeekBtn.addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderWeekGrid();
        });
        nextWeekBtn.addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderWeekGrid();
        });
        todayWeekBtn.addEventListener('click', () => {
            currentWeekStart = getStartOfWeek(new Date());
            renderWeekGrid();
        });
        
        staffSelect.addEventListener('change', renderWeekGrid);
        
        function filterStaffDropdown() {
            const searchTerm = staffSearchInput.value.toLowerCase();
            const selectedId = staffSelect.value;
            staffSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "-- Select a Staff Member --";
            staffSelect.appendChild(defaultOption);
            let isSelectedIdVisible = false;
            allStaff.forEach(staff => {
                if (staff.name.toLowerCase().includes(searchTerm)) {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = staff.name;
                    staffSelect.appendChild(option);
                    if (staff.id === selectedId) isSelectedIdVisible = true;
                }
            });
            if (isSelectedIdVisible) staffSelect.value = selectedId;
        }
        staffSearchInput.addEventListener('input', filterStaffDropdown);


        // --- Work Modal Logic (MODIFIED) ---
        const openWorkModal = async (docId = null, date = null) => {
            workForm.reset();
            document.getElementById('workDocId').value = docId || '';
            deleteWorkBtn.classList.add('hidden');
            flatsDropdownWrapper.classList.add('hidden');
            propertyDropdownWrapper.classList.add('hidden'); // *** ALUTH DROPDOWN EKA HANGANDA ***
            
            const selectedStaffId = staffSelect.value;
            if (!selectedStaffId) {
                showToast("Please select a staff member first.", false);
                return;
            }

            if (docId) { // Edit karaddi
                workModalTitle.textContent = 'Edit Work';
                submitWorkBtnText.textContent = 'Update';
                try {
                    const docRef = doc(db, `users/${currentUserId}/staff_work`, docId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const work = docSnap.data();
                        document.getElementById('taskTitle').value = work.taskTitle;
                        document.getElementById('workCategory').value = work.workCategory;
                        document.getElementById('taskDate').value = work.date.toDate().toISOString().split('T')[0];
                        document.getElementById('taskTime').value = work.date.toDate().toTimeString().split(' ')[0].substring(0, 5);
                        document.getElementById('taskDescription').value = work.description;
                        deleteWorkBtn.classList.remove('hidden');
                        
                        const category = work.workCategory;
                        
                        if (category === 'Condominium') {
                            flatsDropdownWrapper.classList.remove('hidden');
                            if (isFlatsAdminLoggedIn) {
                                await loadFlatsFromExternalDB();
                                flatsSelect.value = work.flatId || '';
                            } else {
                                flatsSelect.innerHTML = '<option value="">-- Please log in to view flats --</option>';
                                openFlatsLoginModal();
                            }
                        } else if (category) {
                            // *** ANITH CATEGORIES WALATA MEKA WADA KARAI ***
                            propertyDropdownWrapper.classList.remove('hidden');
                            await loadGenericProperties(category);
                            propertySelect.value = work.propertyId || '';
                        }
                    }
                } catch (err) {
                    showToast(`Error fetching work: ${err.message}`, false);
                    return;
                }
            } else if (date) { // Aluthen add karaddi
                workModalTitle.textContent = 'Add Work';
                submitWorkBtnText.textContent = 'Save';
                document.getElementById('taskDate').value = date;
            }

            workModal.classList.remove('hidden');
            setTimeout(() => workModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        
        const closeWorkModal = () => {
            workModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                workModal.classList.add('hidden');
                workForm.reset();
                propertyDropdownWrapper.classList.add('hidden'); // *** MODAL EKA CLOSE KARADDI HANGANDA ***
                flatsDropdownWrapper.classList.add('hidden');
            }, 200);
        };

        closeWorkModalBtn.addEventListener('click', closeWorkModal);
        cancelWorkModalBtn.addEventListener('click', closeWorkModal);
        workModal.addEventListener('click', e => { if(e.target === workModal) closeWorkModal(); });
        
        // --- Category select eka wenas karama (MODIFIED) ---
        workCategorySelect.addEventListener('change', e => {
            const selectedCategory = e.target.value;
            
            // Dropdown dekama hide karanna
            flatsDropdownWrapper.classList.add('hidden');
            propertyDropdownWrapper.classList.add('hidden');

            if (selectedCategory === 'Condominium') {
                flatsDropdownWrapper.classList.remove('hidden');
                if (isFlatsAdminLoggedIn) {
                    loadFlatsFromExternalDB(); 
                } else {
                    openFlatsLoginModal(); 
                }
            } else if (selectedCategory) {
                // *** ANITH HAMA CATEGORY EKATAMA MEKA WADA KARAI ***
                // (e.g., "Flat", "Garden", "Gym", "Pool", "Other")
                propertyDropdownWrapper.classList.remove('hidden');
                loadGenericProperties(selectedCategory);
            }
        });

        // --- Form Submit (MODIFIED) ---
        workForm.addEventListener('submit', async e => {
            e.preventDefault();
            const docId = document.getElementById('workDocId').value;
            const selectedStaffId = staffSelect.value;
            const selectedStaffName = staffSelect.options[staffSelect.selectedIndex].text;
            
            if (!selectedStaffId) {
                showToast("No staff member selected.", false); return;
            }

            submitWorkBtn.disabled = true;
            submitWorkBtnText.classList.add('hidden');
            submitWorkSpinner.classList.remove('hidden');

            try {
                const dateStr = document.getElementById('taskDate').value;
                const timeStr = document.getElementById('taskTime').value || '00:00';
                const fullDate = new Date(`${dateStr}T${timeStr}`);
                const selectedWorkCategory = document.getElementById('workCategory').value;
                
                const data = {
                    staffId: selectedStaffId,
                    staffName: selectedStaffName,
                    date: fullDate,
                    taskTitle: document.getElementById('taskTitle').value,
                    workCategory: selectedWorkCategory,
                    description: document.getElementById('taskDescription').value,
                    flatId: null, 
                    flatName: null,
                    propertyId: null, // *** ALUTH FIELD EKA ***
                    propertyName: null // *** ALUTH FIELD EKA ***
                };

                if (selectedWorkCategory === 'Condominium' && flatsSelect.value) {
                    data.flatId = flatsSelect.value;
                    data.flatName = flatsSelect.options[flatsSelect.selectedIndex].text;
                } else if (selectedWorkCategory && propertySelect.value) {
                    // *** ALUTH DROPDOWN EKE DATA SAVE KIRIMA ***
                    data.propertyId = propertySelect.value;
                    data.propertyName = propertySelect.options[propertySelect.selectedIndex].text;
                }

                if (docId) {
                    await updateDoc(doc(db, `users/${currentUserId}/staff_work`, docId), data);
                    showToast('Work assignment updated!');
                } else {
                    await addDoc(collection(db, `users/${currentUserId}/staff_work`), data);
                    showToast('Work assigned successfully!');
                }
                closeWorkModal();
            } catch (err) {
                showToast(`Error: ${err.message}`, false);
            } finally {
                submitWorkBtn.disabled = false;
                submitWorkBtnText.classList.remove('hidden');
                submitWorkSpinner.classList.add('hidden');
            }
        });
        
        deleteWorkBtn.addEventListener('click', async () => {
            const docId = document.getElementById('workDocId').value;
            if (docId && confirm('Are you sure you want to delete this work assignment?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUserId}/staff_work`, docId));
                    showToast('Work assignment deleted.');
                    closeWorkModal();
                } catch (err) {
                    showToast(`Error: ${err.message}`, false);
                }
            }
        });

        // --- Flats Login Modal Logic (wenas wela na) ---
        function openFlatsLoginModal() {
            flatsLoginError.textContent = '';
            flatsLoginModal.classList.remove('hidden');
            setTimeout(() => flatsLoginModalContent.classList.remove('scale-95'), 10);
        }
        
        function closeFlatsLoginModal() {
            flatsLoginModalContent.classList.add('scale-95');
            setTimeout(() => {
                flatsLoginModal.classList.add('hidden');
                flatsLoginForm.reset();
            }, 200);
            
            if (workCategorySelect.value === 'Condominium') {
                workCategorySelect.value = '';
                flatsDropdownWrapper.classList.add('hidden');
            }
        }
        
        closeFlatsLoginModalBtn.addEventListener('click', closeFlatsLoginModal);
        cancelFlatsLoginModalBtn.addEventListener('click', closeFlatsLoginModal);
        
        flatsLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('flatsAdminEmail').value;
            const password = document.getElementById('flatsAdminPassword').value;
            flatsLoginError.textContent = '';
            
            try {
                await signInWithEmailAndPassword(flatsAuth, email, password);
                isFlatsAdminLoggedIn = true;
                showToast('Flats Admin login successful!');
                closeFlatsLoginModal();
                loadFlatsFromExternalDB(); 
            } catch (err) {
                isFlatsAdminLoggedIn = false;
                flatsLoginError.textContent = 'Login failed. Check credentials.';
                console.error("Flats admin login error:", err.message);
            }
        });

        // --- Toast ---
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.className = `fixed bottom-10 right-10 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        lucide.createIcons();
    </script>
</body>
</html>